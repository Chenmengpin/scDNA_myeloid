<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5.2 Functions | Single cell mutational profiling delineates clonal trajectories in myeloid malignancies</title>
  <meta name="description" content="This is a code base for all of the analyses performed in Miles, Bowman et al." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="5.2 Functions | Single cell mutational profiling delineates clonal trajectories in myeloid malignancies" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a code base for all of the analyses performed in Miles, Bowman et al." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5.2 Functions | Single cell mutational profiling delineates clonal trajectories in myeloid malignancies" />
  
  <meta name="twitter:description" content="This is a code base for all of the analyses performed in Miles, Bowman et al." />
  

<meta name="author" content="Robert Bowman" />


<meta name="date" content="2020-10-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="AppendixA.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Foreward</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="data-extraction-and-setup.html"><a href="data-extraction-and-setup.html"><i class="fa fa-check"></i><b>2.1</b> Data Extraction and Setup</a></li>
<li class="chapter" data-level="2.2" data-path="tapestri-library.html"><a href="tapestri-library.html"><i class="fa fa-check"></i><b>2.2</b> Tapestri Package</a></li>
<li class="chapter" data-level="2.3" data-path="post-processing.html"><a href="post-processing.html"><i class="fa fa-check"></i><b>2.3</b> Post processing</a></li>
<li class="chapter" data-level="2.4" data-path="assessing-clonal-abundance.html"><a href="assessing-clonal-abundance.html"><i class="fa fa-check"></i><b>2.4</b> Assessing clonal abundance</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="manuscript-analysis.html"><a href="manuscript-analysis.html"><i class="fa fa-check"></i><b>3</b> Manuscript analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html"><i class="fa fa-check"></i><b>3.1</b> Figure 1: Cohort characterization</a><ul>
<li class="chapter" data-level="3.1.1" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#cohort-characteristics-ef1a-d"><i class="fa fa-check"></i><b>3.1.1</b> Cohort characteristics (EF1A-D)</a></li>
<li class="chapter" data-level="3.1.2" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#mutation-co-occurence"><i class="fa fa-check"></i><b>3.1.2</b> Mutation Co-occurence</a></li>
<li class="chapter" data-level="3.1.3" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#oncoprint-figure-1a"><i class="fa fa-check"></i><b>3.1.3</b> Oncoprint: Figure 1A</a></li>
<li class="chapter" data-level="3.1.4" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#sample-clonality-figure-1ce-figure-2ab"><i class="fa fa-check"></i><b>3.1.4</b> Sample clonality: Figure 1C,E Figure 2A,B</a></li>
<li class="chapter" data-level="3.1.5" data-path="figure-1-cohort-characterization.html"><a href="figure-1-cohort-characterization.html#clonograph-figure-1d"><i class="fa fa-check"></i><b>3.1.5</b> Clonograph: Figure 1D</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html"><i class="fa fa-check"></i><b>3.2</b> Figure 2: Clonality</a><ul>
<li class="chapter" data-level="3.2.1" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html#clonality-in-disease-states"><i class="fa fa-check"></i><b>3.2.1</b> Clonality in disease states</a></li>
<li class="chapter" data-level="3.2.2" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html#clonality-in-co-mutational-groups"><i class="fa fa-check"></i><b>3.2.2</b> Clonality in co-mutational groups</a></li>
<li class="chapter" data-level="3.2.3" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html#clonality-assocation-with-vaf"><i class="fa fa-check"></i><b>3.2.3</b> Clonality assocation with VAF</a></li>
<li class="chapter" data-level="3.2.4" data-path="figure-2-clonality.html"><a href="figure-2-clonality.html#co-mutation-and-clonality"><i class="fa fa-check"></i><b>3.2.4</b> Co-mutation and clonality</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>4</b> Final Words</a></li>
<li class="chapter" data-level="5" data-path="Appendix.html"><a href="Appendix.html"><i class="fa fa-check"></i><b>5</b> Appendix</a><ul>
<li class="chapter" data-level="5.1" data-path="AppendixA.html"><a href="AppendixA.html"><i class="fa fa-check"></i><b>5.1</b> Import from Tapestri Insights</a></li>
<li class="chapter" data-level="5.2" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>5.2</b> Functions</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Single cell mutational profiling delineates clonal trajectories in myeloid malignancies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="functions" class="section level2">
<h2><span class="header-section-number">5.2</span> Functions</h2>
<p>I’m likely going to wrap all of this into a package soon, but here we will start with a set of packages and functions used throughout the study. I need to go through and annotate with package was used with with function, and that will take a little time. So for the sake of making the code available as soon as possible, I’ll present the intermediate product here.</p>
<p>Packages
The following are a list of packages that are used during the study. I will update this list with the minial set and begin to put together a package soon.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="functions.html#cb56-1"></a><span class="kw">library</span>(ape)</span>
<span id="cb56-2"><a href="functions.html#cb56-2"></a><span class="kw">library</span>(circlize)</span>
<span id="cb56-3"><a href="functions.html#cb56-3"></a><span class="kw">library</span>(cooccur)</span>
<span id="cb56-4"><a href="functions.html#cb56-4"></a><span class="kw">library</span>(corrplot)</span>
<span id="cb56-5"><a href="functions.html#cb56-5"></a><span class="kw">library</span>(cowplot)</span>
<span id="cb56-6"><a href="functions.html#cb56-6"></a><span class="kw">library</span>(data.table)</span>
<span id="cb56-7"><a href="functions.html#cb56-7"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb56-8"><a href="functions.html#cb56-8"></a><span class="kw">library</span>(forcats)</span>
<span id="cb56-9"><a href="functions.html#cb56-9"></a><span class="kw">library</span>(gdata)</span>
<span id="cb56-10"><a href="functions.html#cb56-10"></a><span class="kw">library</span>(ggbeeswarm)</span>
<span id="cb56-11"><a href="functions.html#cb56-11"></a><span class="kw">library</span>(ggcorrplot)</span>
<span id="cb56-12"><a href="functions.html#cb56-12"></a><span class="kw">library</span>(ggnet)</span>
<span id="cb56-13"><a href="functions.html#cb56-13"></a><span class="kw">library</span>(ggplotify)</span>
<span id="cb56-14"><a href="functions.html#cb56-14"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb56-15"><a href="functions.html#cb56-15"></a><span class="kw">library</span>(ggrepel)</span>
<span id="cb56-16"><a href="functions.html#cb56-16"></a><span class="kw">library</span>(ggridges)</span>
<span id="cb56-17"><a href="functions.html#cb56-17"></a><span class="kw">library</span>(grid)</span>
<span id="cb56-18"><a href="functions.html#cb56-18"></a><span class="kw">library</span>(gridExtra)</span>
<span id="cb56-19"><a href="functions.html#cb56-19"></a><span class="kw">library</span>(ggthemes)</span>
<span id="cb56-20"><a href="functions.html#cb56-20"></a><span class="kw">library</span>(ggtree)</span>
<span id="cb56-21"><a href="functions.html#cb56-21"></a><span class="kw">library</span>(igraph)</span>
<span id="cb56-22"><a href="functions.html#cb56-22"></a><span class="kw">library</span>(knitr)</span>
<span id="cb56-23"><a href="functions.html#cb56-23"></a><span class="kw">library</span>(miscTools)</span>
<span id="cb56-24"><a href="functions.html#cb56-24"></a><span class="kw">library</span>(network)</span>
<span id="cb56-25"><a href="functions.html#cb56-25"></a><span class="kw">library</span>(pals)</span>
<span id="cb56-26"><a href="functions.html#cb56-26"></a><span class="kw">library</span>(parallel)</span>
<span id="cb56-27"><a href="functions.html#cb56-27"></a><span class="kw">library</span>(pheatmap)</span>
<span id="cb56-28"><a href="functions.html#cb56-28"></a><span class="kw">library</span>(phylobase)</span>
<span id="cb56-29"><a href="functions.html#cb56-29"></a><span class="kw">library</span>(purrr)</span>
<span id="cb56-30"><a href="functions.html#cb56-30"></a><span class="kw">library</span>(qgraph)</span>
<span id="cb56-31"><a href="functions.html#cb56-31"></a><span class="kw">library</span>(RColorBrewer)</span>
<span id="cb56-32"><a href="functions.html#cb56-32"></a><span class="kw">library</span>(rcompanion)</span>
<span id="cb56-33"><a href="functions.html#cb56-33"></a><span class="kw">library</span>(ReinforcementLearning)</span>
<span id="cb56-34"><a href="functions.html#cb56-34"></a><span class="kw">library</span>(reshape2)</span>
<span id="cb56-35"><a href="functions.html#cb56-35"></a><span class="kw">library</span>(sna)</span>
<span id="cb56-36"><a href="functions.html#cb56-36"></a><span class="kw">library</span>(tidygraph)</span>
<span id="cb56-37"><a href="functions.html#cb56-37"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb56-38"><a href="functions.html#cb56-38"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb56-39"><a href="functions.html#cb56-39"></a><span class="kw">library</span>(TRONCO)</span>
<span id="cb56-40"><a href="functions.html#cb56-40"></a><span class="kw">library</span>(vegan)</span>
<span id="cb56-41"><a href="functions.html#cb56-41"></a><span class="kw">library</span>(widyr)</span></code></pre></div>
<p>Custom functions</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="functions.html#cb57-1"></a><span class="kw">options</span>(<span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)</span>
<span id="cb57-2"><a href="functions.html#cb57-2"></a></span>
<span id="cb57-3"><a href="functions.html#cb57-3"></a>random_distribution_NGT_CI &lt;-<span class="st"> </span><span class="cf">function</span>(NGT_to_clone_list,clonal_abundance,sample_to_test,replicates,clone_cutoff){</span>
<span id="cb57-4"><a href="functions.html#cb57-4"></a>                        mat_of_interest &lt;-<span class="st"> </span>NGT_to_clone[[sample_to_test]][,<span class="dv">1</span><span class="op">:</span>(<span class="kw">ncol</span>(NGT_to_clone[[sample_to_test]])<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb57-5"><a href="functions.html#cb57-5"></a>                        bulk_VAF_order &lt;-<span class="kw">names</span>(<span class="kw">sort</span>(<span class="kw">colSums</span>(mat_of_interest),<span class="dt">decreasing=</span><span class="ot">TRUE</span>))</span>
<span id="cb57-6"><a href="functions.html#cb57-6"></a>                        test&lt;-<span class="kw">replicate</span>(<span class="dt">n=</span>replicates,<span class="kw">apply</span>(mat_of_interest,<span class="dt">MARGIN=</span><span class="kw">c</span>(<span class="dv">2</span>),<span class="cf">function</span>(x){</span>
<span id="cb57-7"><a href="functions.html#cb57-7"></a>                          z&lt;-<span class="kw">sample</span>(x,<span class="dt">size=</span><span class="kw">length</span>(x),<span class="dt">replace=</span><span class="ot">FALSE</span>)</span>
<span id="cb57-8"><a href="functions.html#cb57-8"></a>                          <span class="kw">return</span>(<span class="kw">as.numeric</span>(z))}),<span class="dt">simplify =</span> <span class="st">&quot;array&quot;</span>)</span>
<span id="cb57-9"><a href="functions.html#cb57-9"></a>                        test2&lt;-<span class="kw">apply</span>(test,<span class="dv">3</span>,<span class="cf">function</span>(q){</span>
<span id="cb57-10"><a href="functions.html#cb57-10"></a>                          x&lt;-<span class="kw">data.frame</span>(q[,bulk_VAF_order],</span>
<span id="cb57-11"><a href="functions.html#cb57-11"></a>                                        <span class="st">&quot;Clone&quot;</span>=<span class="kw">apply</span>(q[,bulk_VAF_order],<span class="dv">1</span>, <span class="cf">function</span>(p){<span class="kw">paste</span>(p,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)}))</span>
<span id="cb57-12"><a href="functions.html#cb57-12"></a>                          y&lt;-<span class="kw">data.table</span>(<span class="kw">data.frame</span>(<span class="st">&quot;Count&quot;</span>=<span class="kw">as.matrix</span>(<span class="kw">table</span>(x[,<span class="st">&quot;Clone&quot;</span>])),</span>
<span id="cb57-13"><a href="functions.html#cb57-13"></a>                                                   <span class="st">&quot;Clone&quot;</span>=<span class="kw">names</span>(<span class="kw">table</span>(x[,<span class="st">&quot;Clone&quot;</span>]))),</span>
<span id="cb57-14"><a href="functions.html#cb57-14"></a>                                        <span class="dt">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb57-15"><a href="functions.html#cb57-15"></a>                          y<span class="op">$</span>Clone&lt;-<span class="kw">factor</span>(y<span class="op">$</span>Clone,<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">as.character</span>(y<span class="op">$</span>Clone)))</span>
<span id="cb57-16"><a href="functions.html#cb57-16"></a>                          <span class="kw">return</span>(<span class="kw">data.frame</span>(y))})</span>
<span id="cb57-17"><a href="functions.html#cb57-17"></a>                        <span class="cf">if</span>(<span class="kw">class</span>(test2)<span class="op">==</span><span class="st">&quot;list&quot;</span>){y &lt;-<span class="st"> </span><span class="kw">lapply</span>(test2,data.frame) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(full_join, <span class="dt">by =</span> <span class="st">&quot;Clone&quot;</span>)}</span>
<span id="cb57-18"><a href="functions.html#cb57-18"></a>                        <span class="cf">if</span>(<span class="kw">class</span>(test2)<span class="op">==</span><span class="st">&quot;array&quot;</span>){y &lt;-<span class="st"> </span><span class="kw">apply</span>(test2,<span class="dv">3</span>,data.frame) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(full_join, <span class="dt">by =</span> <span class="st">&quot;Clone&quot;</span>)}</span>
<span id="cb57-19"><a href="functions.html#cb57-19"></a>                        y[<span class="kw">is.na</span>(y)]&lt;-<span class="dv">0</span></span>
<span id="cb57-20"><a href="functions.html#cb57-20"></a>                        <span class="kw">rownames</span>(y)&lt;-y[,<span class="st">&quot;Clone&quot;</span>]</span>
<span id="cb57-21"><a href="functions.html#cb57-21"></a>                        y&lt;-<span class="kw">as.matrix</span>(y[,<span class="op">-</span><span class="dv">2</span>])</span>
<span id="cb57-22"><a href="functions.html#cb57-22"></a>                        <span class="kw">mode</span>(y)&lt;-<span class="st">&#39;numeric&#39;</span></span>
<span id="cb57-23"><a href="functions.html#cb57-23"></a>                        z&lt;-<span class="kw">t</span>(<span class="kw">apply</span>(y,<span class="dv">1</span>,<span class="cf">function</span>(p){<span class="kw">quantile</span>(p,<span class="dt">probs=</span><span class="kw">c</span>(<span class="fl">0.025</span>,<span class="fl">0.975</span>))}))</span>
<span id="cb57-24"><a href="functions.html#cb57-24"></a>                        z_mat&lt;-<span class="kw">data.frame</span>(z,<span class="st">&quot;Clone&quot;</span>=<span class="kw">rownames</span>(z))</span>
<span id="cb57-25"><a href="functions.html#cb57-25"></a>                        set&lt;-<span class="kw">setNames</span>(<span class="kw">data.frame</span>(<span class="kw">full_join</span>(<span class="kw">data.frame</span>(clonal_abundance[[sample_to_test]]),z_mat,<span class="dt">by=</span><span class="st">&quot;Clone&quot;</span>)),<span class="kw">c</span>(<span class="st">&quot;Count&quot;</span>,<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;LCI&quot;</span>,<span class="st">&quot;UCI&quot;</span>))<span class="op">%&gt;%</span><span class="kw">filter</span>(LCI<span class="op">&gt;=</span>clone_cutoff<span class="op">&amp;!</span><span class="kw">is.na</span>(Count))</span>
<span id="cb57-26"><a href="functions.html#cb57-26"></a>                        <span class="kw">return</span>(set)</span>
<span id="cb57-27"><a href="functions.html#cb57-27"></a>}</span>
<span id="cb57-28"><a href="functions.html#cb57-28"></a></span>
<span id="cb57-29"><a href="functions.html#cb57-29"></a>bootstrap_allele_dropout_NGT_mat &lt;-<span class="st"> </span><span class="cf">function</span>(NGT_to_clone_list,clonal_abundance,sample_to_test,replicates,clone_cutoff){</span>
<span id="cb57-30"><a href="functions.html#cb57-30"></a>                  mat_of_interest &lt;-<span class="st"> </span>NGT_to_clone[[sample_to_test]][,<span class="dv">1</span><span class="op">:</span>(<span class="kw">ncol</span>(NGT_to_clone[[sample_to_test]])<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb57-31"><a href="functions.html#cb57-31"></a>                  bulk_VAF_order &lt;-<span class="kw">names</span>(<span class="kw">sort</span>(<span class="kw">colSums</span>(mat_of_interest),<span class="dt">decreasing=</span><span class="ot">TRUE</span>))</span>
<span id="cb57-32"><a href="functions.html#cb57-32"></a>                  test&lt;-<span class="kw">replicate</span>(<span class="dt">n=</span>replicates,<span class="kw">apply</span>(mat_of_interest,<span class="dt">MARGIN=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="cf">function</span>(x){</span>
<span id="cb57-33"><a href="functions.html#cb57-33"></a>                    <span class="cf">if</span>(x<span class="op">==</span><span class="dv">1</span>){z&lt;-x} </span>
<span id="cb57-34"><a href="functions.html#cb57-34"></a>                    <span class="cf">if</span>(x<span class="op">==</span><span class="dv">0</span>){z&lt;-<span class="kw">sample</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="dt">size=</span><span class="dv">1</span>,<span class="dt">prob=</span><span class="kw">c</span>(<span class="fl">0.9</span>,<span class="fl">0.1</span>))}</span>
<span id="cb57-35"><a href="functions.html#cb57-35"></a>                    <span class="cf">if</span>(x<span class="op">==</span><span class="dv">2</span>){z&lt;-<span class="kw">sample</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>),<span class="dt">size=</span><span class="dv">1</span>,<span class="dt">prob=</span><span class="kw">c</span>(<span class="fl">0.9</span>,<span class="fl">0.1</span>))}</span>
<span id="cb57-36"><a href="functions.html#cb57-36"></a>                    <span class="kw">return</span>(<span class="kw">as.numeric</span>(z))}),<span class="dt">simplify =</span> <span class="st">&quot;array&quot;</span>)</span>
<span id="cb57-37"><a href="functions.html#cb57-37"></a>                  test2&lt;-<span class="kw">apply</span>(test,<span class="dv">3</span>,<span class="cf">function</span>(q){</span>
<span id="cb57-38"><a href="functions.html#cb57-38"></a>                    x&lt;-<span class="kw">data.frame</span>(q[,bulk_VAF_order],</span>
<span id="cb57-39"><a href="functions.html#cb57-39"></a>                                  <span class="st">&quot;Clone&quot;</span>=<span class="kw">apply</span>(q[,bulk_VAF_order],<span class="dv">1</span>, <span class="cf">function</span>(p){<span class="kw">paste</span>(p,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)}))</span>
<span id="cb57-40"><a href="functions.html#cb57-40"></a>                    y&lt;-<span class="kw">data.table</span>(<span class="kw">data.frame</span>(<span class="st">&quot;Count&quot;</span>=<span class="kw">as.matrix</span>(<span class="kw">table</span>(x[,<span class="st">&quot;Clone&quot;</span>])),</span>
<span id="cb57-41"><a href="functions.html#cb57-41"></a>                                             <span class="st">&quot;Clone&quot;</span>=<span class="kw">names</span>(<span class="kw">table</span>(x[,<span class="st">&quot;Clone&quot;</span>]))),</span>
<span id="cb57-42"><a href="functions.html#cb57-42"></a>                                  <span class="dt">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb57-43"><a href="functions.html#cb57-43"></a>                    y<span class="op">$</span>Clone&lt;-<span class="kw">factor</span>(y<span class="op">$</span>Clone,<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">as.character</span>(y<span class="op">$</span>Clone)))</span>
<span id="cb57-44"><a href="functions.html#cb57-44"></a>                    <span class="kw">return</span>(<span class="kw">data.frame</span>(y))})</span>
<span id="cb57-45"><a href="functions.html#cb57-45"></a>                  </span>
<span id="cb57-46"><a href="functions.html#cb57-46"></a>                  <span class="cf">if</span>(<span class="kw">class</span>(test2)<span class="op">==</span><span class="st">&quot;list&quot;</span>){y &lt;-<span class="st"> </span><span class="kw">lapply</span>(test2,data.frame) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(full_join, <span class="dt">by =</span> <span class="st">&quot;Clone&quot;</span>)}</span>
<span id="cb57-47"><a href="functions.html#cb57-47"></a>                  <span class="cf">if</span>(<span class="kw">class</span>(test2)<span class="op">==</span><span class="st">&quot;array&quot;</span>){y &lt;-<span class="st"> </span><span class="kw">apply</span>(test2,<span class="dv">3</span>,data.frame) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(full_join, <span class="dt">by =</span> <span class="st">&quot;Clone&quot;</span>)}</span>
<span id="cb57-48"><a href="functions.html#cb57-48"></a>                  y[<span class="kw">is.na</span>(y)]&lt;-<span class="dv">0</span></span>
<span id="cb57-49"><a href="functions.html#cb57-49"></a>                  <span class="kw">rownames</span>(y)&lt;-y[,<span class="st">&quot;Clone&quot;</span>]</span>
<span id="cb57-50"><a href="functions.html#cb57-50"></a>                  y&lt;-<span class="kw">as.matrix</span>(y[,<span class="op">-</span><span class="dv">2</span>])</span>
<span id="cb57-51"><a href="functions.html#cb57-51"></a>                  <span class="kw">mode</span>(y)&lt;-<span class="st">&#39;numeric&#39;</span></span>
<span id="cb57-52"><a href="functions.html#cb57-52"></a>                  z&lt;-<span class="kw">t</span>(<span class="kw">apply</span>(y,<span class="dv">1</span>,<span class="cf">function</span>(p){<span class="kw">quantile</span>(p,<span class="dt">probs=</span><span class="kw">c</span>(<span class="fl">0.025</span>,<span class="fl">0.975</span>))}))</span>
<span id="cb57-53"><a href="functions.html#cb57-53"></a>                  z_mat&lt;-<span class="kw">data.frame</span>(z,<span class="st">&quot;Clone&quot;</span>=<span class="kw">rownames</span>(z))</span>
<span id="cb57-54"><a href="functions.html#cb57-54"></a>                  set&lt;-<span class="kw">setNames</span>(<span class="kw">data.frame</span>(<span class="kw">full_join</span>(<span class="kw">data.frame</span>(clonal_abundance[[sample_to_test]]),z_mat,<span class="dt">by=</span><span class="st">&quot;Clone&quot;</span>)),<span class="kw">c</span>(<span class="st">&quot;Count&quot;</span>,<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;LCI&quot;</span>,<span class="st">&quot;UCI&quot;</span>))<span class="op">%&gt;%</span><span class="kw">filter</span>(LCI<span class="op">&gt;=</span>clone_cutoff<span class="op">&amp;!</span><span class="kw">is.na</span>(Count))</span>
<span id="cb57-55"><a href="functions.html#cb57-55"></a>                  <span class="kw">return</span>(set)</span>
<span id="cb57-56"><a href="functions.html#cb57-56"></a>} </span>
<span id="cb57-57"><a href="functions.html#cb57-57"></a></span>
<span id="cb57-58"><a href="functions.html#cb57-58"></a>bootstrap_NGT_mat &lt;-<span class="st"> </span><span class="cf">function</span>(NGT_to_clone_list,clonal_abundance,sample_to_test,replicates,clone_cutoff){</span>
<span id="cb57-59"><a href="functions.html#cb57-59"></a>  test&lt;-<span class="kw">replicate</span>(<span class="dt">n=</span>replicates,<span class="kw">resample_fun</span>(NGT_to_clone[[sample_to_test]]),<span class="dt">simplify =</span> <span class="st">&quot;array&quot;</span>)</span>
<span id="cb57-60"><a href="functions.html#cb57-60"></a>  <span class="cf">if</span>(<span class="kw">class</span>(test)<span class="op">==</span><span class="st">&quot;list&quot;</span>){</span>
<span id="cb57-61"><a href="functions.html#cb57-61"></a>    y &lt;-<span class="st"> </span><span class="kw">lapply</span>(test,data.frame) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(full_join, <span class="dt">by =</span> <span class="st">&quot;Clone&quot;</span>)</span>
<span id="cb57-62"><a href="functions.html#cb57-62"></a>  }</span>
<span id="cb57-63"><a href="functions.html#cb57-63"></a>  <span class="cf">if</span>(<span class="kw">class</span>(test)<span class="op">==</span><span class="st">&quot;array&quot;</span>){</span>
<span id="cb57-64"><a href="functions.html#cb57-64"></a>    y &lt;-<span class="st"> </span><span class="kw">apply</span>(test,<span class="dv">3</span>,data.frame) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(full_join, <span class="dt">by =</span> <span class="st">&quot;Clone&quot;</span>)</span>
<span id="cb57-65"><a href="functions.html#cb57-65"></a>  }</span>
<span id="cb57-66"><a href="functions.html#cb57-66"></a>  y[<span class="kw">is.na</span>(y)]&lt;-<span class="dv">0</span></span>
<span id="cb57-67"><a href="functions.html#cb57-67"></a>  <span class="kw">rownames</span>(y)&lt;-y[,<span class="st">&quot;Clone&quot;</span>]</span>
<span id="cb57-68"><a href="functions.html#cb57-68"></a>  y&lt;-<span class="kw">as.matrix</span>(y[,<span class="op">-</span><span class="dv">2</span>])</span>
<span id="cb57-69"><a href="functions.html#cb57-69"></a>  <span class="kw">mode</span>(y)&lt;-<span class="st">&#39;numeric&#39;</span></span>
<span id="cb57-70"><a href="functions.html#cb57-70"></a>  z&lt;-<span class="kw">t</span>(<span class="kw">apply</span>(y,<span class="dv">1</span>,<span class="cf">function</span>(p){</span>
<span id="cb57-71"><a href="functions.html#cb57-71"></a>    <span class="kw">quantile</span>(p,<span class="dt">probs=</span><span class="kw">c</span>(<span class="fl">0.025</span>,<span class="fl">0.975</span>))</span>
<span id="cb57-72"><a href="functions.html#cb57-72"></a>  }))</span>
<span id="cb57-73"><a href="functions.html#cb57-73"></a>  z_mat&lt;-<span class="kw">data.frame</span>(z,<span class="st">&quot;Clone&quot;</span>=<span class="kw">rownames</span>(z))</span>
<span id="cb57-74"><a href="functions.html#cb57-74"></a>  set&lt;-<span class="kw">setNames</span>(<span class="kw">data.frame</span>(<span class="kw">inner_join</span>(<span class="kw">data.frame</span>(clonal_abundance[[sample_to_test]]),z_mat,<span class="dt">by=</span><span class="st">&quot;Clone&quot;</span>)),<span class="kw">c</span>(<span class="st">&quot;Count&quot;</span>,<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;LCI&quot;</span>,<span class="st">&quot;UCI&quot;</span>))<span class="op">%&gt;%</span><span class="kw">filter</span>(LCI<span class="op">&gt;=</span>clone_cutoff)</span>
<span id="cb57-75"><a href="functions.html#cb57-75"></a>  <span class="kw">return</span>(set)</span>
<span id="cb57-76"><a href="functions.html#cb57-76"></a>}</span>
<span id="cb57-77"><a href="functions.html#cb57-77"></a></span>
<span id="cb57-78"><a href="functions.html#cb57-78"></a>resample_fun&lt;-<span class="cf">function</span>(data){</span>
<span id="cb57-79"><a href="functions.html#cb57-79"></a>  x &lt;-<span class="st"> </span>data[<span class="kw">sample</span>(<span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(data),<span class="dt">replace=</span><span class="ot">TRUE</span>),]</span>
<span id="cb57-80"><a href="functions.html#cb57-80"></a>  <span class="kw">return</span>(<span class="kw">as.matrix</span>(<span class="kw">data.table</span>(<span class="kw">data.frame</span>(<span class="st">&quot;Count&quot;</span>=<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">table</span>(x[,<span class="st">&quot;Clone&quot;</span>])),</span>
<span id="cb57-81"><a href="functions.html#cb57-81"></a>                                         <span class="st">&quot;Clone&quot;</span>=<span class="kw">names</span>(<span class="kw">table</span>(x[,<span class="st">&quot;Clone&quot;</span>]))),</span>
<span id="cb57-82"><a href="functions.html#cb57-82"></a>                              <span class="dt">key=</span><span class="st">&quot;Count&quot;</span>)))</span>
<span id="cb57-83"><a href="functions.html#cb57-83"></a>}</span>
<span id="cb57-84"><a href="functions.html#cb57-84"></a></span>
<span id="cb57-85"><a href="functions.html#cb57-85"></a>extract_NGT_files &lt;-<span class="st"> </span><span class="cf">function</span>(sample,variants){</span>
<span id="cb57-86"><a href="functions.html#cb57-86"></a>  NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-87"><a href="functions.html#cb57-87"></a>  <span class="kw">return</span>(NGT)</span>
<span id="cb57-88"><a href="functions.html#cb57-88"></a>}</span>
<span id="cb57-89"><a href="functions.html#cb57-89"></a></span>
<span id="cb57-90"><a href="functions.html#cb57-90"></a>count_unknown_cells&lt;-<span class="st"> </span><span class="cf">function</span>(sample,variants){</span>
<span id="cb57-91"><a href="functions.html#cb57-91"></a>    NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-92"><a href="functions.html#cb57-92"></a>    cells_with_unknown&lt;-NGT[<span class="kw">apply</span>(NGT[,variants],<span class="dt">MARGIN=</span><span class="dv">1</span>,<span class="dt">FUN=</span><span class="cf">function</span>(x){<span class="kw">sum</span>(x<span class="op">==</span><span class="dv">3</span>)<span class="op">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb57-93"><a href="functions.html#cb57-93"></a>    <span class="kw">return</span>(<span class="kw">c</span>(<span class="kw">length</span>(cells_with_unknown)<span class="op">/</span><span class="kw">nrow</span>(NGT)))</span>
<span id="cb57-94"><a href="functions.html#cb57-94"></a>  }</span>
<span id="cb57-95"><a href="functions.html#cb57-95"></a></span>
<span id="cb57-96"><a href="functions.html#cb57-96"></a>extract_DP_files &lt;-<span class="st"> </span><span class="cf">function</span>(sample,variants){</span>
<span id="cb57-97"><a href="functions.html#cb57-97"></a>  DP &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-98"><a href="functions.html#cb57-98"></a>  cells_with_unknown&lt;-DP[<span class="kw">apply</span>(DP[,variants],<span class="dt">MARGIN=</span><span class="dv">1</span>,<span class="dt">FUN=</span><span class="cf">function</span>(x){<span class="kw">sum</span>(x<span class="op">==</span><span class="dv">3</span>)<span class="op">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb57-99"><a href="functions.html#cb57-99"></a>  matrix_of_interest&lt;-DP[<span class="op">!</span>DP<span class="op">$</span>Cell<span class="op">%in%</span>cells_with_unknown,variants]</span>
<span id="cb57-100"><a href="functions.html#cb57-100"></a>  <span class="kw">return</span>(matrix_of_interest)</span>
<span id="cb57-101"><a href="functions.html#cb57-101"></a>}</span>
<span id="cb57-102"><a href="functions.html#cb57-102"></a></span>
<span id="cb57-103"><a href="functions.html#cb57-103"></a>extract_SNP_info &lt;-<span class="st"> </span><span class="cf">function</span>(sample){</span>
<span id="cb57-104"><a href="functions.html#cb57-104"></a>  AF &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                  </span>
<span id="cb57-105"><a href="functions.html#cb57-105"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-106"><a href="functions.html#cb57-106"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-107"><a href="functions.html#cb57-107"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-108"><a href="functions.html#cb57-108"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-109"><a href="functions.html#cb57-109"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-110"><a href="functions.html#cb57-110"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-111"><a href="functions.html#cb57-111"></a>                    <span class="kw">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-112"><a href="functions.html#cb57-112"></a>    })</span>
<span id="cb57-113"><a href="functions.html#cb57-113"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-114"><a href="functions.html#cb57-114"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-115"><a href="functions.html#cb57-115"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-116"><a href="functions.html#cb57-116"></a>    <span class="kw">colnames</span>(SNP_INFO)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;protein&quot;</span></span>
<span id="cb57-117"><a href="functions.html#cb57-117"></a>    SNP_INFO<span class="op">$</span>cDNA &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>cDNA)</span>
<span id="cb57-118"><a href="functions.html#cb57-118"></a>    SNP_INFO<span class="op">$</span>protein &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>protein)</span>
<span id="cb57-119"><a href="functions.html#cb57-119"></a>    SNP_INFO<span class="op">$</span>Variant &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Variant)</span>
<span id="cb57-120"><a href="functions.html#cb57-120"></a>    SNP_INFO<span class="op">$</span>Gene &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Gene)</span>
<span id="cb57-121"><a href="functions.html#cb57-121"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-122"><a href="functions.html#cb57-122"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-123"><a href="functions.html#cb57-123"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-124"><a href="functions.html#cb57-124"></a>                    <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-125"><a href="functions.html#cb57-125"></a>     }) </span>
<span id="cb57-126"><a href="functions.html#cb57-126"></a>  }</span>
<span id="cb57-127"><a href="functions.html#cb57-127"></a>  <span class="kw">return</span>(SNP_INFO)</span>
<span id="cb57-128"><a href="functions.html#cb57-128"></a>}</span>
<span id="cb57-129"><a href="functions.html#cb57-129"></a></span>
<span id="cb57-130"><a href="functions.html#cb57-130"></a><span class="co"># run the following just once to load the function</span></span>
<span id="cb57-131"><a href="functions.html#cb57-131"></a>plot_variants_and_selection &lt;-<span class="st"> </span><span class="cf">function</span>(sample){</span>
<span id="cb57-132"><a href="functions.html#cb57-132"></a>  <span class="co">#Load in the data</span></span>
<span id="cb57-133"><a href="functions.html#cb57-133"></a>  AF &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb57-134"><a href="functions.html#cb57-134"></a>  DP &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb57-135"><a href="functions.html#cb57-135"></a>  GQ &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb57-136"><a href="functions.html#cb57-136"></a>  NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb57-137"><a href="functions.html#cb57-137"></a>  </span>
<span id="cb57-138"><a href="functions.html#cb57-138"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-139"><a href="functions.html#cb57-139"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-140"><a href="functions.html#cb57-140"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-141"><a href="functions.html#cb57-141"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-142"><a href="functions.html#cb57-142"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-143"><a href="functions.html#cb57-143"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-144"><a href="functions.html#cb57-144"></a>                    <span class="kw">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-145"><a href="functions.html#cb57-145"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-146"><a href="functions.html#cb57-146"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-147"><a href="functions.html#cb57-147"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-148"><a href="functions.html#cb57-148"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-149"><a href="functions.html#cb57-149"></a>    <span class="kw">colnames</span>(SNP_INFO)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;protein&quot;</span></span>
<span id="cb57-150"><a href="functions.html#cb57-150"></a>    SNP_INFO<span class="op">$</span>cDNA &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>cDNA)</span>
<span id="cb57-151"><a href="functions.html#cb57-151"></a>    SNP_INFO<span class="op">$</span>protein &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>protein)</span>
<span id="cb57-152"><a href="functions.html#cb57-152"></a>    SNP_INFO<span class="op">$</span>Variant &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Variant)</span>
<span id="cb57-153"><a href="functions.html#cb57-153"></a>    SNP_INFO<span class="op">$</span>Gene &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Gene)</span>
<span id="cb57-154"><a href="functions.html#cb57-154"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-155"><a href="functions.html#cb57-155"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-156"><a href="functions.html#cb57-156"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-157"><a href="functions.html#cb57-157"></a>                    <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-158"><a href="functions.html#cb57-158"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-159"><a href="functions.html#cb57-159"></a>  }</span>
<span id="cb57-160"><a href="functions.html#cb57-160"></a>  </span>
<span id="cb57-161"><a href="functions.html#cb57-161"></a>  protein_changes_of_interest &lt;-<span class="st"> </span>(SNP_INFO <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(protein<span class="op">!=</span><span class="st">&quot;&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(protein))[,<span class="dv">1</span>] <span class="co"># select column of variants</span></span>
<span id="cb57-162"><a href="functions.html#cb57-162"></a>  SNP_changes_of_interest &lt;-<span class="st"> </span><span class="kw">rownames</span>(SNP_INFO)[SNP_INFO[,<span class="st">&quot;protein&quot;</span>]<span class="op">%in%</span>protein_changes_of_interest]</span>
<span id="cb57-163"><a href="functions.html#cb57-163"></a>  SNP_protein_key &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Mutant&quot;</span>=SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span>=protein_changes_of_interest)</span>
<span id="cb57-164"><a href="functions.html#cb57-164"></a>  </span>
<span id="cb57-165"><a href="functions.html#cb57-165"></a>  <span class="co"># Cell and clone selection and Average depth per cell per allele</span></span>
<span id="cb57-166"><a href="functions.html#cb57-166"></a>  distribution_of_unknowns_by_variant &lt;-<span class="st"> </span><span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb57-167"><a href="functions.html#cb57-167"></a>  NGT_subset&lt;-NGT[,<span class="kw">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>,SNP_changes_of_interest)]</span>
<span id="cb57-168"><a href="functions.html#cb57-168"></a>  <span class="co">#NGT_interest$Clone &lt;- apply(NGT_interest[,-c(1,2)],1,function(x){paste(x,sep=&quot;_&quot;,collapse=&quot;_&quot;)})</span></span>
<span id="cb57-169"><a href="functions.html#cb57-169"></a>  <span class="co">#clonal_abundance &lt;- sort(table(NGT_interest$Clone))</span></span>
<span id="cb57-170"><a href="functions.html#cb57-170"></a>  </span>
<span id="cb57-171"><a href="functions.html#cb57-171"></a>  DP_subset&lt;-<span class="st"> </span>DP[,<span class="kw">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>,SNP_changes_of_interest)]</span>
<span id="cb57-172"><a href="functions.html#cb57-172"></a>  DP_NGT_melt&lt;-<span class="kw">inner_join</span>(<span class="kw">melt</span>(DP_subset[,<span class="op">-</span><span class="dv">1</span>],<span class="dt">id.var=</span><span class="st">&quot;Cell&quot;</span>),<span class="kw">melt</span>(NGT_subset[,<span class="op">-</span><span class="dv">1</span>],<span class="dt">id.var=</span><span class="st">&quot;Cell&quot;</span>),<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;variable&quot;</span>))</span>
<span id="cb57-173"><a href="functions.html#cb57-173"></a>  <span class="kw">colnames</span>(DP_NGT_melt) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Depth&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb57-174"><a href="functions.html#cb57-174"></a>  DP_NGT_melt<span class="op">$</span>Genotype &lt;-<span class="st"> </span><span class="kw">ifelse</span>(DP_NGT_melt<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">3</span>,<span class="st">&quot;Unknown&quot;</span>,</span>
<span id="cb57-175"><a href="functions.html#cb57-175"></a>                                 <span class="kw">ifelse</span>(DP_NGT_melt<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb57-176"><a href="functions.html#cb57-176"></a>                                        <span class="kw">ifelse</span>(DP_NGT_melt<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb57-177"><a href="functions.html#cb57-177"></a>                                               <span class="kw">ifelse</span>(DP_NGT_melt<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,DP_NGT_melt<span class="op">$</span>Genotype))))</span>
<span id="cb57-178"><a href="functions.html#cb57-178"></a>  DP_NGT_melt<span class="op">$</span>Genotype  &lt;-<span class="st"> </span><span class="kw">factor</span>(DP_NGT_melt<span class="op">$</span>Genotype ,<span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>,<span class="st">&quot;Unknown&quot;</span>))</span>
<span id="cb57-179"><a href="functions.html#cb57-179"></a>  </span>
<span id="cb57-180"><a href="functions.html#cb57-180"></a>  summarized&lt;-<span class="kw">data.frame</span>(DP_NGT_melt<span class="op">%&gt;%</span><span class="kw">group_by</span>(Mutant,Genotype)<span class="op">%&gt;%</span><span class="kw">summarise</span>(<span class="st">&quot;Depth&quot;</span>=<span class="kw">mean</span>(Depth)))</span>
<span id="cb57-181"><a href="functions.html#cb57-181"></a>  summarized_no_unknown &lt;-<span class="st"> </span>summarized <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Genotype<span class="op">!=</span><span class="st">&quot;Unknown&quot;</span>)</span>
<span id="cb57-182"><a href="functions.html#cb57-182"></a>  grouped &lt;-<span class="st"> </span><span class="kw">group_by</span>(summarized_no_unknown, Mutant)</span>
<span id="cb57-183"><a href="functions.html#cb57-183"></a>  output &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">summarise</span>(grouped, <span class="dt">mean=</span><span class="kw">mean</span>(Depth), <span class="dt">sd=</span><span class="kw">sd</span>(Depth))) </span>
<span id="cb57-184"><a href="functions.html#cb57-184"></a>  output<span class="op">$</span>Include &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;Include&quot;</span>,<span class="kw">length</span>(<span class="kw">rownames</span>(output)))</span>
<span id="cb57-185"><a href="functions.html#cb57-185"></a>  output_final &lt;-<span class="st"> </span><span class="kw">inner_join</span>(SNP_protein_key,output)</span>
<span id="cb57-186"><a href="functions.html#cb57-186"></a>  </span>
<span id="cb57-187"><a href="functions.html#cb57-187"></a>  depth_plot&lt;-<span class="st"> </span><span class="kw">ggplot</span>(summarized_no_unknown,<span class="kw">aes</span>(<span class="dt">x=</span>Mutant,<span class="dt">y=</span>Depth,<span class="dt">color=</span>Genotype))<span class="op">+</span><span class="kw">geom_point</span>()<span class="op">+</span><span class="kw">coord_flip</span>()<span class="op">+</span></span>
<span id="cb57-188"><a href="functions.html#cb57-188"></a><span class="st">    </span><span class="kw">scale_x_discrete</span>(<span class="dt">limits =</span> <span class="kw">rev</span>(<span class="kw">levels</span>(summarized_no_unknown<span class="op">$</span>Mutant)))<span class="op">+</span><span class="kw">theme_bw</span>()<span class="co">#+</span></span>
<span id="cb57-189"><a href="functions.html#cb57-189"></a>  </span>
<span id="cb57-190"><a href="functions.html#cb57-190"></a>  <span class="kw">write.csv</span>(output_final,<span class="kw">paste0</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION.csv&quot;</span>),<span class="dt">row.names=</span><span class="ot">FALSE</span>)</span>
<span id="cb57-191"><a href="functions.html#cb57-191"></a>  <span class="kw">ggsave</span>(<span class="kw">paste0</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION.pdf&quot;</span>),depth_plot,<span class="dt">width=</span><span class="dv">10</span>,<span class="dt">height=</span><span class="dv">20</span>)</span>
<span id="cb57-192"><a href="functions.html#cb57-192"></a>}</span>
<span id="cb57-193"><a href="functions.html#cb57-193"></a></span>
<span id="cb57-194"><a href="functions.html#cb57-194"></a>run_mbio_analysis&lt;-<span class="cf">function</span>(sample,diversity){</span>
<span id="cb57-195"><a href="functions.html#cb57-195"></a>  <span class="co">#Load in the data</span></span>
<span id="cb57-196"><a href="functions.html#cb57-196"></a>  </span>
<span id="cb57-197"><a href="functions.html#cb57-197"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-198"><a href="functions.html#cb57-198"></a>    LAM_VARIANTS_MAT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-199"><a href="functions.html#cb57-199"></a>    LAM_VARIANTS_SNP &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb57-200"><a href="functions.html#cb57-200"></a>    LAM_VARIANTS_Protein &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb57-201"><a href="functions.html#cb57-201"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-202"><a href="functions.html#cb57-202"></a>    <span class="kw">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb57-203"><a href="functions.html#cb57-203"></a>    <span class="kw">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb57-204"><a href="functions.html#cb57-204"></a>  }</span>
<span id="cb57-205"><a href="functions.html#cb57-205"></a>  AF &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb57-206"><a href="functions.html#cb57-206"></a>  DP &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb57-207"><a href="functions.html#cb57-207"></a>  GQ &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb57-208"><a href="functions.html#cb57-208"></a>  NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb57-209"><a href="functions.html#cb57-209"></a>  </span>
<span id="cb57-210"><a href="functions.html#cb57-210"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-211"><a href="functions.html#cb57-211"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-212"><a href="functions.html#cb57-212"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-213"><a href="functions.html#cb57-213"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-214"><a href="functions.html#cb57-214"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-215"><a href="functions.html#cb57-215"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-216"><a href="functions.html#cb57-216"></a>                    <span class="kw">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-217"><a href="functions.html#cb57-217"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-218"><a href="functions.html#cb57-218"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-219"><a href="functions.html#cb57-219"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-220"><a href="functions.html#cb57-220"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-221"><a href="functions.html#cb57-221"></a>    <span class="kw">colnames</span>(SNP_INFO)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;protein&quot;</span></span>
<span id="cb57-222"><a href="functions.html#cb57-222"></a>    SNP_INFO<span class="op">$</span>cDNA &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>cDNA)</span>
<span id="cb57-223"><a href="functions.html#cb57-223"></a>    SNP_INFO<span class="op">$</span>protein &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>protein)</span>
<span id="cb57-224"><a href="functions.html#cb57-224"></a>    SNP_INFO<span class="op">$</span>Variant &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Variant)</span>
<span id="cb57-225"><a href="functions.html#cb57-225"></a>    SNP_INFO<span class="op">$</span>Gene &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Gene)</span>
<span id="cb57-226"><a href="functions.html#cb57-226"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-227"><a href="functions.html#cb57-227"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-228"><a href="functions.html#cb57-228"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-229"><a href="functions.html#cb57-229"></a>                    <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-230"><a href="functions.html#cb57-230"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-231"><a href="functions.html#cb57-231"></a>  }</span>
<span id="cb57-232"><a href="functions.html#cb57-232"></a>  </span>
<span id="cb57-233"><a href="functions.html#cb57-233"></a>  SNP_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_SNP</span>
<span id="cb57-234"><a href="functions.html#cb57-234"></a>  protein_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_Protein</span>
<span id="cb57-235"><a href="functions.html#cb57-235"></a>  SNP_protein_key &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Mutant&quot;</span>=SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span>=protein_changes_of_interest)</span>
<span id="cb57-236"><a href="functions.html#cb57-236"></a>  </span>
<span id="cb57-237"><a href="functions.html#cb57-237"></a>  <span class="co"># Cell and clone selection</span></span>
<span id="cb57-238"><a href="functions.html#cb57-238"></a>  distribution_of_unknowns_by_variant &lt;-<span class="st"> </span><span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb57-239"><a href="functions.html#cb57-239"></a>  <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb57-240"><a href="functions.html#cb57-240"></a>  cells_with_unknown&lt;-NGT[<span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">1</span>,<span class="dt">FUN=</span><span class="cf">function</span>(x){<span class="kw">sum</span>(x<span class="op">==</span><span class="dv">3</span>)<span class="op">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb57-241"><a href="functions.html#cb57-241"></a>  matrix_of_interest&lt;-NGT[<span class="op">!</span>NGT<span class="op">$</span>Cell<span class="op">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb57-242"><a href="functions.html#cb57-242"></a>  bulk_VAF_order&lt;-SNP_INFO[<span class="kw">colnames</span>(matrix_of_interest)[<span class="kw">order</span>(<span class="kw">colSums</span>(matrix_of_interest),<span class="dt">decreasing=</span><span class="ot">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb57-243"><a href="functions.html#cb57-243"></a>  bulk_VAF_order &lt;-<span class="st"> </span>bulk_VAF_order[<span class="op">!</span><span class="kw">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb57-244"><a href="functions.html#cb57-244"></a>  matrix_of_interest<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-245"><a href="functions.html#cb57-245"></a>  clonal_abundance &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">table</span>(matrix_of_interest<span class="op">$</span>Clone))</span>
<span id="cb57-246"><a href="functions.html#cb57-246"></a>  clones_to_include&lt;-<span class="kw">names</span>(clonal_abundance)[clonal_abundance<span class="op">&gt;</span><span class="kw">length</span>(<span class="kw">rownames</span>(matrix_of_interest))<span class="op">*</span><span class="dv">0</span>]</span>
<span id="cb57-247"><a href="functions.html#cb57-247"></a>  matrix_subset_clones &lt;-<span class="st"> </span>matrix_of_interest[matrix_of_interest<span class="op">$</span>Clone<span class="op">%in%</span>clones_to_include,]</span>
<span id="cb57-248"><a href="functions.html#cb57-248"></a>  </span>
<span id="cb57-249"><a href="functions.html#cb57-249"></a>  <span class="co">#Average depth per cell per allele</span></span>
<span id="cb57-250"><a href="functions.html#cb57-250"></a>  DP_subset&lt;-<span class="st"> </span>DP[<span class="op">-</span>cells_with_unknown,<span class="kw">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>,<span class="kw">rownames</span>(SNP_INFO)[SNP_INFO<span class="op">$</span>protein<span class="op">%in%</span>protein_changes_of_interest])]</span>
<span id="cb57-251"><a href="functions.html#cb57-251"></a>  NGT_subset &lt;-<span class="st"> </span>NGT[NGT<span class="op">$</span>Cell<span class="op">%in%</span>DP_subset<span class="op">$</span>Cell,<span class="kw">colnames</span>(DP_subset)]</span>
<span id="cb57-252"><a href="functions.html#cb57-252"></a>  DP_NGT_melt&lt;-<span class="kw">inner_join</span>(<span class="kw">melt</span>(DP_subset[,<span class="op">-</span><span class="dv">1</span>],<span class="dt">id.var=</span><span class="st">&quot;Cell&quot;</span>),<span class="kw">melt</span>(NGT[,<span class="op">-</span><span class="dv">1</span>],<span class="dt">id.var=</span><span class="st">&quot;Cell&quot;</span>),<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;variable&quot;</span>))</span>
<span id="cb57-253"><a href="functions.html#cb57-253"></a>  <span class="kw">colnames</span>(DP_NGT_melt) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Depth&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb57-254"><a href="functions.html#cb57-254"></a>  DP_NGT_melt<span class="op">$</span>Genotype &lt;-<span class="st"> </span><span class="kw">ifelse</span>(DP_NGT_melt<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">3</span>,<span class="st">&quot;Unknown&quot;</span>,</span>
<span id="cb57-255"><a href="functions.html#cb57-255"></a>                                 <span class="kw">ifelse</span>(DP_NGT_melt<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb57-256"><a href="functions.html#cb57-256"></a>                                        <span class="kw">ifelse</span>(DP_NGT_melt<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb57-257"><a href="functions.html#cb57-257"></a>                                               <span class="kw">ifelse</span>(DP_NGT_melt<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,DP_NGT_melt<span class="op">$</span>Genotype))))</span>
<span id="cb57-258"><a href="functions.html#cb57-258"></a>  DP_NGT_melt<span class="op">$</span>Genotype  &lt;-<span class="st"> </span><span class="kw">factor</span>(DP_NGT_melt<span class="op">$</span>Genotype ,<span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>,<span class="st">&quot;Unknown&quot;</span>))</span>
<span id="cb57-259"><a href="functions.html#cb57-259"></a>  </span>
<span id="cb57-260"><a href="functions.html#cb57-260"></a>  summarized&lt;-<span class="kw">data.frame</span>(DP_NGT_melt<span class="op">%&gt;%</span><span class="kw">group_by</span>(Mutant,Genotype)<span class="op">%&gt;%</span><span class="kw">summarise</span>(<span class="st">&quot;Depth&quot;</span>=<span class="kw">mean</span>(Depth)))</span>
<span id="cb57-261"><a href="functions.html#cb57-261"></a>  </span>
<span id="cb57-262"><a href="functions.html#cb57-262"></a>  </span>
<span id="cb57-263"><a href="functions.html#cb57-263"></a>  <span class="co"># Verify variants selected are unique and encode protein changes</span></span>
<span id="cb57-264"><a href="functions.html#cb57-264"></a>  <span class="op">!</span><span class="kw">any</span>(<span class="kw">duplicated</span>(SNP_INFO[<span class="kw">colnames</span>(matrix_subset_clones),<span class="st">&quot;protein&quot;</span>])) <span class="co">#Should return TRUE</span></span>
<span id="cb57-265"><a href="functions.html#cb57-265"></a>  <span class="kw">colnames</span>(matrix_subset_clones)&lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">as.character</span>(SNP_INFO[<span class="kw">colnames</span>(matrix_subset_clones)[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(SNP_changes_of_interest)],<span class="st">&quot;protein&quot;</span>]),<span class="st">&quot;Clone&quot;</span>)</span>
<span id="cb57-266"><a href="functions.html#cb57-266"></a>  </span>
<span id="cb57-267"><a href="functions.html#cb57-267"></a>  <span class="co"># Aggregate data to get clone counts and architecture.</span></span>
<span id="cb57-268"><a href="functions.html#cb57-268"></a>  dedup&lt;-matrix_subset_clones[<span class="op">!</span><span class="kw">duplicated</span>(matrix_subset_clones),]</span>
<span id="cb57-269"><a href="functions.html#cb57-269"></a>  clonal_architecture &lt;-<span class="st"> </span><span class="kw">melt</span>(dedup)</span>
<span id="cb57-270"><a href="functions.html#cb57-270"></a>  <span class="kw">colnames</span>(clonal_architecture) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb57-271"><a href="functions.html#cb57-271"></a>  clonal_architecture<span class="op">$</span>Genotype &lt;-<span class="st"> </span><span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">3</span>,<span class="ot">NA</span>,</span>
<span id="cb57-272"><a href="functions.html#cb57-272"></a>                                         <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb57-273"><a href="functions.html#cb57-273"></a>                                                <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb57-274"><a href="functions.html#cb57-274"></a>                                                       <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,clonal_architecture<span class="op">$</span>Genotype))))</span>
<span id="cb57-275"><a href="functions.html#cb57-275"></a>  clonal_architecture<span class="op">$</span>Genotype  &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_architecture<span class="op">$</span>Genotype ,<span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>))</span>
<span id="cb57-276"><a href="functions.html#cb57-276"></a>  clonal_abundance &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Count&quot;</span>=<span class="kw">as.matrix</span>(<span class="kw">table</span>(matrix_subset_clones<span class="op">$</span>Clone)))</span>
<span id="cb57-277"><a href="functions.html#cb57-277"></a>  clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">rownames</span>(clonal_abundance)</span>
<span id="cb57-278"><a href="functions.html#cb57-278"></a>  clonal_abundance &lt;-<span class="st"> </span><span class="kw">data.table</span>(clonal_abundance,<span class="dt">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb57-279"><a href="functions.html#cb57-279"></a>  clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_abundance<span class="op">$</span>Clone,<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">c</span>(clonal_abundance<span class="op">$</span>Clone)))</span>
<span id="cb57-280"><a href="functions.html#cb57-280"></a>  clonal_architecture<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">as.character</span>(clonal_architecture<span class="op">$</span>Clone),<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">as.character</span>(clonal_abundance<span class="op">$</span>Clone)))</span>
<span id="cb57-281"><a href="functions.html#cb57-281"></a>  clonal_architecture<span class="op">$</span>Mutant &lt;-<span class="kw">factor</span>(clonal_architecture<span class="op">$</span>Mutant , <span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">as.character</span>(bulk_VAF_order)))</span>
<span id="cb57-282"><a href="functions.html#cb57-282"></a>  </span>
<span id="cb57-283"><a href="functions.html#cb57-283"></a>  <span class="co"># Generate clonal architecture heatmap</span></span>
<span id="cb57-284"><a href="functions.html#cb57-284"></a>  gg_heatmap &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> clonal_architecture, <span class="kw">aes</span>(<span class="dt">x =</span> Clone, <span class="dt">y =</span> <span class="kw">factor</span>(Mutant), <span class="dt">fill =</span> Genotype)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-285"><a href="functions.html#cb57-285"></a><span class="st">    </span><span class="kw">geom_tile</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-286"><a href="functions.html#cb57-286"></a><span class="st">    </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb57-287"><a href="functions.html#cb57-287"></a>                               <span class="st">&quot;Heterozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb57-288"><a href="functions.html#cb57-288"></a>                               <span class="st">&quot;Homozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb57-289"><a href="functions.html#cb57-289"></a>                               <span class="st">&quot;Unknown&quot;</span>=<span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="op">+</span></span>
<span id="cb57-290"><a href="functions.html#cb57-290"></a><span class="st">    </span><span class="kw">theme_classic</span>() <span class="op">+</span></span>
<span id="cb57-291"><a href="functions.html#cb57-291"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="op">+</span></span>
<span id="cb57-292"><a href="functions.html#cb57-292"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb57-293"><a href="functions.html#cb57-293"></a>          <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(), </span>
<span id="cb57-294"><a href="functions.html#cb57-294"></a>          <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-295"><a href="functions.html#cb57-295"></a>          <span class="dt">axis.title.x=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-296"><a href="functions.html#cb57-296"></a>          <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb57-297"><a href="functions.html#cb57-297"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-298"><a href="functions.html#cb57-298"></a>  </span>
<span id="cb57-299"><a href="functions.html#cb57-299"></a>  <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb57-300"><a href="functions.html#cb57-300"></a>  gg_clonal_barplot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(clonal_abundance), <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">factor</span>(Clone), <span class="dt">y =</span> Count)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-301"><a href="functions.html#cb57-301"></a><span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="kw">aes</span>(<span class="dt">fill =</span> Count)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_gray</span>() <span class="op">+</span></span>
<span id="cb57-302"><a href="functions.html#cb57-302"></a><span class="st">    </span><span class="kw">theme_classic</span>()<span class="op">+</span></span>
<span id="cb57-303"><a href="functions.html#cb57-303"></a><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="kw">max</span>(clonal_abundance<span class="op">$</span>Count)<span class="op">*</span><span class="fl">1.3</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-304"><a href="functions.html#cb57-304"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="op">+</span></span>
<span id="cb57-305"><a href="functions.html#cb57-305"></a><span class="st">    </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label=</span>Count), <span class="dt">position=</span><span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="fl">0.9</span>), <span class="dt">vjust=</span><span class="op">-</span><span class="fl">0.25</span>)<span class="op">+</span></span>
<span id="cb57-306"><a href="functions.html#cb57-306"></a><span class="st">    </span><span class="kw">scale_fill_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Reds&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb57-307"><a href="functions.html#cb57-307"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(),  <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-308"><a href="functions.html#cb57-308"></a>          <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb57-309"><a href="functions.html#cb57-309"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="op">-</span><span class="fl">0.2</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-310"><a href="functions.html#cb57-310"></a>  </span>
<span id="cb57-311"><a href="functions.html#cb57-311"></a>  <span class="co"># Generate genotype calls by allele</span></span>
<span id="cb57-312"><a href="functions.html#cb57-312"></a>  distribution_of_unknowns_by_variant &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">2</span>,<span class="cf">function</span>(x){<span class="kw">table</span>(<span class="kw">factor</span>(x,<span class="dt">levels=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)))}))</span>
<span id="cb57-313"><a href="functions.html#cb57-313"></a>  <span class="kw">rownames</span>(distribution_of_unknowns_by_variant) &lt;-<span class="st"> </span>SNP_INFO[<span class="kw">rownames</span>(distribution_of_unknowns_by_variant),<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb57-314"><a href="functions.html#cb57-314"></a>  <span class="kw">colnames</span>(distribution_of_unknowns_by_variant) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>,<span class="st">&quot;Unknown&quot;</span>)</span>
<span id="cb57-315"><a href="functions.html#cb57-315"></a>  allele_melted &lt;-<span class="kw">melt</span>(distribution_of_unknowns_by_variant) </span>
<span id="cb57-316"><a href="functions.html#cb57-316"></a>  <span class="kw">colnames</span>(allele_melted) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>,<span class="st">&quot;Cells&quot;</span>)</span>
<span id="cb57-317"><a href="functions.html#cb57-317"></a>  allele_melted<span class="op">$</span>Genotype &lt;-<span class="st"> </span><span class="kw">factor</span>(allele_melted<span class="op">$</span>Genotype,<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>,<span class="st">&quot;Unknown&quot;</span>)))</span>
<span id="cb57-318"><a href="functions.html#cb57-318"></a>  allele_melted<span class="op">$</span>Mutant &lt;-<span class="kw">factor</span>(allele_melted<span class="op">$</span>Mutant , <span class="dt">levels=</span><span class="kw">as.character</span>(bulk_VAF_order))</span>
<span id="cb57-319"><a href="functions.html#cb57-319"></a>  </span>
<span id="cb57-320"><a href="functions.html#cb57-320"></a>  <span class="co">#Generate allele barplot</span></span>
<span id="cb57-321"><a href="functions.html#cb57-321"></a>  gg_alleles &lt;-<span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(allele_melted), <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">factor</span>(Mutant), <span class="dt">y =</span> Cells)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-322"><a href="functions.html#cb57-322"></a><span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="kw">aes</span>(<span class="dt">fill =</span> Genotype),<span class="dt">position=</span><span class="st">&quot;stack&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_gray</span>() <span class="op">+</span></span>
<span id="cb57-323"><a href="functions.html#cb57-323"></a><span class="st">    </span><span class="kw">theme_minimal</span>()<span class="op">+</span></span>
<span id="cb57-324"><a href="functions.html#cb57-324"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="op">+</span></span>
<span id="cb57-325"><a href="functions.html#cb57-325"></a><span class="st">    </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb57-326"><a href="functions.html#cb57-326"></a>                               <span class="st">&quot;Heterozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb57-327"><a href="functions.html#cb57-327"></a>                               <span class="st">&quot;Homozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb57-328"><a href="functions.html#cb57-328"></a>                               <span class="st">&quot;Unknown&quot;</span>=<span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>) <span class="op">+</span></span>
<span id="cb57-329"><a href="functions.html#cb57-329"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle=</span><span class="dv">30</span>,<span class="dt">hjust=</span><span class="dv">1</span>,<span class="dt">vjust=</span><span class="dv">1</span>))</span>
<span id="cb57-330"><a href="functions.html#cb57-330"></a>  </span>
<span id="cb57-331"><a href="functions.html#cb57-331"></a>  </span>
<span id="cb57-332"><a href="functions.html#cb57-332"></a>  <span class="co">#Generate depth by alelle by mutant                       </span></span>
<span id="cb57-333"><a href="functions.html#cb57-333"></a>  gg_depth &lt;-<span class="st"> </span><span class="kw">ggplot</span>(summarized,<span class="kw">aes</span>(<span class="dt">x=</span>Mutant,<span class="dt">color=</span>Genotype,<span class="dt">y=</span>Depth))<span class="op">+</span></span>
<span id="cb57-334"><a href="functions.html#cb57-334"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">position=</span><span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="fl">0.4</span>))<span class="op">+</span></span>
<span id="cb57-335"><a href="functions.html#cb57-335"></a><span class="st">    </span><span class="kw">scale_color_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb57-336"><a href="functions.html#cb57-336"></a>                                <span class="st">&quot;Heterozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb57-337"><a href="functions.html#cb57-337"></a>                                <span class="st">&quot;Homozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb57-338"><a href="functions.html#cb57-338"></a>                                <span class="st">&quot;Unknown&quot;</span>=<span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>) <span class="op">+</span></span>
<span id="cb57-339"><a href="functions.html#cb57-339"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle=</span><span class="dv">30</span>,<span class="dt">hjust=</span><span class="dv">1</span>,<span class="dt">vjust=</span><span class="dv">1</span>),</span>
<span id="cb57-340"><a href="functions.html#cb57-340"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-341"><a href="functions.html#cb57-341"></a>  </span>
<span id="cb57-342"><a href="functions.html#cb57-342"></a>  <span class="co"># Compute spacing of graphs</span></span>
<span id="cb57-343"><a href="functions.html#cb57-343"></a>  plots &lt;-<span class="st"> </span><span class="kw">list</span>(gg_depth,gg_clonal_barplot,gg_alleles,gg_heatmap)</span>
<span id="cb57-344"><a href="functions.html#cb57-344"></a>  grobs &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb57-345"><a href="functions.html#cb57-345"></a>  widths &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb57-346"><a href="functions.html#cb57-346"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(plots)){</span>
<span id="cb57-347"><a href="functions.html#cb57-347"></a>    grobs[[i]] &lt;-<span class="st"> </span><span class="kw">ggplotGrob</span>(plots[[i]])</span>
<span id="cb57-348"><a href="functions.html#cb57-348"></a>    widths[[i]] &lt;-<span class="st"> </span>grobs[[i]]<span class="op">$</span>widths[<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>]</span>
<span id="cb57-349"><a href="functions.html#cb57-349"></a>  }</span>
<span id="cb57-350"><a href="functions.html#cb57-350"></a>  maxwidth &lt;-<span class="st"> </span><span class="kw">do.call</span>(grid<span class="op">::</span>unit.pmax, widths)</span>
<span id="cb57-351"><a href="functions.html#cb57-351"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(grobs)){</span>
<span id="cb57-352"><a href="functions.html#cb57-352"></a>    grobs[[i]]<span class="op">$</span>widths[<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>] &lt;-<span class="st"> </span><span class="kw">as.list</span>(maxwidth)</span>
<span id="cb57-353"><a href="functions.html#cb57-353"></a>  }</span>
<span id="cb57-354"><a href="functions.html#cb57-354"></a>  </span>
<span id="cb57-355"><a href="functions.html#cb57-355"></a>  <span class="co"># Generate plot</span></span>
<span id="cb57-356"><a href="functions.html#cb57-356"></a>  grob.title &lt;-<span class="st"> </span><span class="kw">textGrob</span>(sample, <span class="dt">hjust =</span> <span class="fl">0.5</span>, <span class="dt">vjust =</span> <span class="fl">0.5</span>, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">20</span>))</span>
<span id="cb57-357"><a href="functions.html#cb57-357"></a>  <span class="kw">pdf</span>(<span class="kw">paste</span>(output_folder,<span class="st">&quot;Graphs/&quot;</span>,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>), <span class="dt">width =</span> <span class="dv">16</span>, <span class="dt">height =</span> <span class="dv">8</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb57-358"><a href="functions.html#cb57-358"></a>  <span class="kw">grid.arrange</span>(<span class="dt">grobs=</span>grobs, <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">top =</span> grob.title)</span>
<span id="cb57-359"><a href="functions.html#cb57-359"></a>  <span class="kw">graphics.off</span>()</span>
<span id="cb57-360"><a href="functions.html#cb57-360"></a>  </span>
<span id="cb57-361"><a href="functions.html#cb57-361"></a>  </span>
<span id="cb57-362"><a href="functions.html#cb57-362"></a>  <span class="cf">if</span>(diversity<span class="op">==</span><span class="ot">TRUE</span>){</span>
<span id="cb57-363"><a href="functions.html#cb57-363"></a>    clonal_abundance_mat &lt;-<span class="st"> </span>clonal_abundance</span>
<span id="cb57-364"><a href="functions.html#cb57-364"></a>    clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">rownames</span>(clonal_abundance)</span>
<span id="cb57-365"><a href="functions.html#cb57-365"></a>    clonal_abundance_mat<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">rownames</span>(clonal_abundance_mat)</span>
<span id="cb57-366"><a href="functions.html#cb57-366"></a>    clonal_abundance_count &lt;-<span class="st"> </span><span class="kw">data.table</span>(clonal_abundance,<span class="dt">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb57-367"><a href="functions.html#cb57-367"></a>    shannon &lt;-<span class="st"> </span><span class="kw">diversity</span>(clonal_abundance_mat[,<span class="st">&quot;Count&quot;</span>])</span>
<span id="cb57-368"><a href="functions.html#cb57-368"></a>    <span class="kw">write.csv2</span>(shannon,<span class="kw">paste</span>(output_folder,<span class="st">&quot;Diversity_score/&quot;</span>,sample,<span class="st">&quot;.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))</span>
<span id="cb57-369"><a href="functions.html#cb57-369"></a>  }</span>
<span id="cb57-370"><a href="functions.html#cb57-370"></a>}</span>
<span id="cb57-371"><a href="functions.html#cb57-371"></a></span>
<span id="cb57-372"><a href="functions.html#cb57-372"></a></span>
<span id="cb57-373"><a href="functions.html#cb57-373"></a>stats_output&lt;-<span class="cf">function</span>(sample){</span>
<span id="cb57-374"><a href="functions.html#cb57-374"></a>  <span class="co">#Load in the data</span></span>
<span id="cb57-375"><a href="functions.html#cb57-375"></a>  </span>
<span id="cb57-376"><a href="functions.html#cb57-376"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-377"><a href="functions.html#cb57-377"></a>    LAM_VARIANTS_MAT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-378"><a href="functions.html#cb57-378"></a>    LAM_VARIANTS_SNP &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb57-379"><a href="functions.html#cb57-379"></a>    LAM_VARIANTS_Protein &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb57-380"><a href="functions.html#cb57-380"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-381"><a href="functions.html#cb57-381"></a>    <span class="kw">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb57-382"><a href="functions.html#cb57-382"></a>    <span class="kw">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb57-383"><a href="functions.html#cb57-383"></a>  }</span>
<span id="cb57-384"><a href="functions.html#cb57-384"></a>  AF &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb57-385"><a href="functions.html#cb57-385"></a>  DP &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb57-386"><a href="functions.html#cb57-386"></a>  GQ &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb57-387"><a href="functions.html#cb57-387"></a>  NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb57-388"><a href="functions.html#cb57-388"></a>  </span>
<span id="cb57-389"><a href="functions.html#cb57-389"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-390"><a href="functions.html#cb57-390"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-391"><a href="functions.html#cb57-391"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-392"><a href="functions.html#cb57-392"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-393"><a href="functions.html#cb57-393"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-394"><a href="functions.html#cb57-394"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-395"><a href="functions.html#cb57-395"></a>                    <span class="kw">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-396"><a href="functions.html#cb57-396"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-397"><a href="functions.html#cb57-397"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-398"><a href="functions.html#cb57-398"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-399"><a href="functions.html#cb57-399"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-400"><a href="functions.html#cb57-400"></a>    <span class="kw">colnames</span>(SNP_INFO)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;protein&quot;</span></span>
<span id="cb57-401"><a href="functions.html#cb57-401"></a>    SNP_INFO<span class="op">$</span>cDNA &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>cDNA)</span>
<span id="cb57-402"><a href="functions.html#cb57-402"></a>    SNP_INFO<span class="op">$</span>protein &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>protein)</span>
<span id="cb57-403"><a href="functions.html#cb57-403"></a>    SNP_INFO<span class="op">$</span>Variant &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Variant)</span>
<span id="cb57-404"><a href="functions.html#cb57-404"></a>    SNP_INFO<span class="op">$</span>Gene &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Gene)</span>
<span id="cb57-405"><a href="functions.html#cb57-405"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-406"><a href="functions.html#cb57-406"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-407"><a href="functions.html#cb57-407"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-408"><a href="functions.html#cb57-408"></a>                    <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-409"><a href="functions.html#cb57-409"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-410"><a href="functions.html#cb57-410"></a>  }</span>
<span id="cb57-411"><a href="functions.html#cb57-411"></a>  </span>
<span id="cb57-412"><a href="functions.html#cb57-412"></a>  SNP_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_SNP</span>
<span id="cb57-413"><a href="functions.html#cb57-413"></a>  protein_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_Protein</span>
<span id="cb57-414"><a href="functions.html#cb57-414"></a>  SNP_protein_key &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Mutant&quot;</span>=SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span>=protein_changes_of_interest)</span>
<span id="cb57-415"><a href="functions.html#cb57-415"></a>  </span>
<span id="cb57-416"><a href="functions.html#cb57-416"></a>  <span class="co"># Cell and clone selection</span></span>
<span id="cb57-417"><a href="functions.html#cb57-417"></a>  distribution_of_unknowns_by_variant &lt;-<span class="st"> </span><span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb57-418"><a href="functions.html#cb57-418"></a>  <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb57-419"><a href="functions.html#cb57-419"></a>  cells_with_unknown&lt;-NGT[<span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">1</span>,<span class="dt">FUN=</span><span class="cf">function</span>(x){<span class="kw">sum</span>(x<span class="op">==</span><span class="dv">3</span>)<span class="op">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb57-420"><a href="functions.html#cb57-420"></a>  matrix_of_interest&lt;-NGT[<span class="op">!</span>NGT<span class="op">$</span>Cell<span class="op">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb57-421"><a href="functions.html#cb57-421"></a>  bulk_VAF_order&lt;-SNP_INFO[<span class="kw">colnames</span>(matrix_of_interest)[<span class="kw">order</span>(<span class="kw">colSums</span>(matrix_of_interest),<span class="dt">decreasing=</span><span class="ot">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb57-422"><a href="functions.html#cb57-422"></a>  bulk_VAF_order &lt;-<span class="st"> </span>bulk_VAF_order[<span class="op">!</span><span class="kw">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb57-423"><a href="functions.html#cb57-423"></a>  matrix_of_interest<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-424"><a href="functions.html#cb57-424"></a></span>
<span id="cb57-425"><a href="functions.html#cb57-425"></a>  <span class="co"># Aggregate data to get clone counts and architecture.</span></span>
<span id="cb57-426"><a href="functions.html#cb57-426"></a>  dedup&lt;-matrix_of_interest[<span class="op">!</span><span class="kw">duplicated</span>(matrix_of_interest),]</span>
<span id="cb57-427"><a href="functions.html#cb57-427"></a>  clonal_abundance &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Count&quot;</span>=<span class="kw">as.matrix</span>(<span class="kw">table</span>(matrix_of_interest<span class="op">$</span>Clone)))</span>
<span id="cb57-428"><a href="functions.html#cb57-428"></a>  clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st">  </span><span class="kw">factor</span>(<span class="kw">rownames</span>(clonal_abundance),<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">c</span>(<span class="kw">rownames</span>(clonal_abundance))))</span>
<span id="cb57-429"><a href="functions.html#cb57-429"></a>  clonal_abundance<span class="op">$</span>Count &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(clonal_abundance<span class="op">$</span>Count)</span>
<span id="cb57-430"><a href="functions.html#cb57-430"></a>  clonal_abundance<span class="op">$</span>Dominance &lt;-<span class="st"> </span><span class="kw">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-431"><a href="functions.html#cb57-431"></a>    (<span class="kw">as.numeric</span>(x[<span class="st">&quot;Count&quot;</span>])<span class="op">/</span><span class="kw">sum</span>(clonal_abundance[<span class="st">&quot;Count&quot;</span>]) ) <span class="op">/</span><span class="st"> </span>(<span class="kw">max</span>(<span class="kw">as.numeric</span>(clonal_abundance[,<span class="st">&quot;Count&quot;</span>]))<span class="op">/</span><span class="kw">sum</span>(clonal_abundance[<span class="st">&quot;Count&quot;</span>]))</span>
<span id="cb57-432"><a href="functions.html#cb57-432"></a>  })</span>
<span id="cb57-433"><a href="functions.html#cb57-433"></a>  clonal_abundance<span class="op">$</span>Mutation_count &lt;-<span class="st"> </span><span class="kw">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-434"><a href="functions.html#cb57-434"></a>    <span class="kw">sum</span>(<span class="kw">as.numeric</span>(<span class="kw">strsplit</span>( <span class="kw">as.character</span>(x[<span class="dv">2</span>]),<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)[[<span class="dv">1</span>]]))</span>
<span id="cb57-435"><a href="functions.html#cb57-435"></a>  })</span>
<span id="cb57-436"><a href="functions.html#cb57-436"></a>  shannon &lt;-<span class="st"> </span><span class="kw">diversity</span>(clonal_abundance[,<span class="st">&quot;Count&quot;</span>])</span>
<span id="cb57-437"><a href="functions.html#cb57-437"></a>  <span class="kw">print</span>(shannon)</span>
<span id="cb57-438"><a href="functions.html#cb57-438"></a>  matrix_output &lt;-<span class="st"> </span>dedup<span class="op">%&gt;%</span><span class="kw">select</span>(<span class="op">-</span>Clone)</span>
<span id="cb57-439"><a href="functions.html#cb57-439"></a>  matrix_output_t &lt;-<span class="st"> </span><span class="kw">t</span>(matrix_output)</span>
<span id="cb57-440"><a href="functions.html#cb57-440"></a>  <span class="kw">rownames</span>(matrix_output_t) &lt;-<span class="st"> </span><span class="dv">0</span><span class="op">:</span>(<span class="kw">dim</span>(matrix_output_t)[[<span class="dv">1</span>]]<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb57-441"><a href="functions.html#cb57-441"></a>  <span class="kw">write.table</span>(shannon,<span class="kw">paste0</span>(output_folder,<span class="st">&quot;Diversity_score/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>,<span class="dt">row.names=</span><span class="ot">FALSE</span>)</span>
<span id="cb57-442"><a href="functions.html#cb57-442"></a>  <span class="kw">write.table</span>(matrix_output_t,<span class="kw">paste0</span>(output_folder,<span class="st">&quot;Genotype_matrix/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="dt">sep=</span><span class="st">&quot; &quot;</span>,<span class="dt">row.names=</span><span class="ot">TRUE</span>,<span class="dt">quote=</span><span class="ot">FALSE</span>,<span class="dt">col.names =</span> <span class="ot">FALSE</span>)</span>
<span id="cb57-443"><a href="functions.html#cb57-443"></a>  <span class="kw">write.table</span>(clonal_abundance,<span class="kw">paste0</span>(output_folder,<span class="st">&quot;Summary_mat/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>,<span class="dt">row.names=</span><span class="ot">FALSE</span>)</span>
<span id="cb57-444"><a href="functions.html#cb57-444"></a>}</span>
<span id="cb57-445"><a href="functions.html#cb57-445"></a></span>
<span id="cb57-446"><a href="functions.html#cb57-446"></a></span>
<span id="cb57-447"><a href="functions.html#cb57-447"></a>permute_data &lt;-<span class="st"> </span><span class="cf">function</span>(sample,nrun){</span>
<span id="cb57-448"><a href="functions.html#cb57-448"></a>  <span class="co">#Load in the data</span></span>
<span id="cb57-449"><a href="functions.html#cb57-449"></a>  </span>
<span id="cb57-450"><a href="functions.html#cb57-450"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-451"><a href="functions.html#cb57-451"></a>    LAM_VARIANTS_MAT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-452"><a href="functions.html#cb57-452"></a>    LAM_VARIANTS_SNP &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb57-453"><a href="functions.html#cb57-453"></a>    LAM_VARIANTS_Protein &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb57-454"><a href="functions.html#cb57-454"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-455"><a href="functions.html#cb57-455"></a>    <span class="kw">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb57-456"><a href="functions.html#cb57-456"></a>    <span class="kw">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb57-457"><a href="functions.html#cb57-457"></a>  }</span>
<span id="cb57-458"><a href="functions.html#cb57-458"></a>  AF &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb57-459"><a href="functions.html#cb57-459"></a>  DP &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb57-460"><a href="functions.html#cb57-460"></a>  GQ &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb57-461"><a href="functions.html#cb57-461"></a>  NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb57-462"><a href="functions.html#cb57-462"></a>  </span>
<span id="cb57-463"><a href="functions.html#cb57-463"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-464"><a href="functions.html#cb57-464"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-465"><a href="functions.html#cb57-465"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-466"><a href="functions.html#cb57-466"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-467"><a href="functions.html#cb57-467"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-468"><a href="functions.html#cb57-468"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-469"><a href="functions.html#cb57-469"></a>                    <span class="kw">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-470"><a href="functions.html#cb57-470"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-471"><a href="functions.html#cb57-471"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-472"><a href="functions.html#cb57-472"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-473"><a href="functions.html#cb57-473"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-474"><a href="functions.html#cb57-474"></a>    <span class="kw">colnames</span>(SNP_INFO)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;protein&quot;</span></span>
<span id="cb57-475"><a href="functions.html#cb57-475"></a>    SNP_INFO<span class="op">$</span>cDNA &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>cDNA)</span>
<span id="cb57-476"><a href="functions.html#cb57-476"></a>    SNP_INFO<span class="op">$</span>protein &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>protein)</span>
<span id="cb57-477"><a href="functions.html#cb57-477"></a>    SNP_INFO<span class="op">$</span>Variant &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Variant)</span>
<span id="cb57-478"><a href="functions.html#cb57-478"></a>    SNP_INFO<span class="op">$</span>Gene &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Gene)</span>
<span id="cb57-479"><a href="functions.html#cb57-479"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-480"><a href="functions.html#cb57-480"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-481"><a href="functions.html#cb57-481"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-482"><a href="functions.html#cb57-482"></a>                    <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-483"><a href="functions.html#cb57-483"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-484"><a href="functions.html#cb57-484"></a>  }</span>
<span id="cb57-485"><a href="functions.html#cb57-485"></a>  </span>
<span id="cb57-486"><a href="functions.html#cb57-486"></a>  SNP_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_SNP</span>
<span id="cb57-487"><a href="functions.html#cb57-487"></a>  protein_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_Protein</span>
<span id="cb57-488"><a href="functions.html#cb57-488"></a>  SNP_protein_key &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Mutant&quot;</span>=SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span>=protein_changes_of_interest)</span>
<span id="cb57-489"><a href="functions.html#cb57-489"></a>  </span>
<span id="cb57-490"><a href="functions.html#cb57-490"></a>  <span class="co"># Cell and clone selection</span></span>
<span id="cb57-491"><a href="functions.html#cb57-491"></a>  distribution_of_unknowns_by_variant &lt;-<span class="st"> </span><span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb57-492"><a href="functions.html#cb57-492"></a>  <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb57-493"><a href="functions.html#cb57-493"></a>  cells_with_unknown&lt;-NGT[<span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">1</span>,<span class="dt">FUN=</span><span class="cf">function</span>(x){<span class="kw">sum</span>(x<span class="op">==</span><span class="dv">3</span>)<span class="op">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb57-494"><a href="functions.html#cb57-494"></a>  matrix_of_interest&lt;-NGT[<span class="op">!</span>NGT<span class="op">$</span>Cell<span class="op">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb57-495"><a href="functions.html#cb57-495"></a>  bulk_VAF_order&lt;-SNP_INFO[<span class="kw">colnames</span>(matrix_of_interest)[<span class="kw">order</span>(<span class="kw">colSums</span>(matrix_of_interest),<span class="dt">decreasing=</span><span class="ot">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb57-496"><a href="functions.html#cb57-496"></a>  bulk_VAF_order &lt;-<span class="st"> </span>bulk_VAF_order[<span class="op">!</span><span class="kw">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb57-497"><a href="functions.html#cb57-497"></a>  matrix_of_interest<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-498"><a href="functions.html#cb57-498"></a>  </span>
<span id="cb57-499"><a href="functions.html#cb57-499"></a>  <span class="co"># Aggregate data to get clone counts and architecture.</span></span>
<span id="cb57-500"><a href="functions.html#cb57-500"></a>  dedup&lt;-matrix_of_interest[<span class="op">!</span><span class="kw">duplicated</span>(matrix_of_interest),]</span>
<span id="cb57-501"><a href="functions.html#cb57-501"></a>  clonal_abundance &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Count&quot;</span>=<span class="kw">as.matrix</span>(<span class="kw">table</span>(matrix_of_interest<span class="op">$</span>Clone)))</span>
<span id="cb57-502"><a href="functions.html#cb57-502"></a>  clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st">  </span><span class="kw">factor</span>(<span class="kw">rownames</span>(clonal_abundance),<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">c</span>(<span class="kw">rownames</span>(clonal_abundance))))</span>
<span id="cb57-503"><a href="functions.html#cb57-503"></a>  clonal_abundance<span class="op">$</span>Count &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(clonal_abundance<span class="op">$</span>Count)</span>
<span id="cb57-504"><a href="functions.html#cb57-504"></a>  </span>
<span id="cb57-505"><a href="functions.html#cb57-505"></a>  clonal_architecture &lt;-<span class="st"> </span><span class="kw">melt</span>(dedup)</span>
<span id="cb57-506"><a href="functions.html#cb57-506"></a>  <span class="kw">colnames</span>(clonal_architecture) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb57-507"><a href="functions.html#cb57-507"></a>  clonal_architecture<span class="op">$</span>Genotype &lt;-<span class="st"> </span><span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">3</span>,<span class="ot">NA</span>,</span>
<span id="cb57-508"><a href="functions.html#cb57-508"></a>                                         <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb57-509"><a href="functions.html#cb57-509"></a>                                                <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb57-510"><a href="functions.html#cb57-510"></a>                                                       <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,clonal_architecture<span class="op">$</span>Genotype))))</span>
<span id="cb57-511"><a href="functions.html#cb57-511"></a>  clonal_architecture<span class="op">$</span>Genotype  &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_architecture<span class="op">$</span>Genotype ,<span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>))</span>
<span id="cb57-512"><a href="functions.html#cb57-512"></a></span>
<span id="cb57-513"><a href="functions.html#cb57-513"></a>  results_holder &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span>nrun))</span>
<span id="cb57-514"><a href="functions.html#cb57-514"></a>  randomization_list&lt;-<span class="kw">lapply</span>(results_holder,<span class="cf">function</span>(x){</span>
<span id="cb57-515"><a href="functions.html#cb57-515"></a>    <span class="kw">apply</span>(matrix_of_interest[,<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(<span class="kw">colnames</span>(matrix_of_interest))<span class="op">-</span><span class="dv">1</span>],<span class="dv">2</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-516"><a href="functions.html#cb57-516"></a>      y &lt;-<span class="st"> </span><span class="kw">sample</span>(x,<span class="kw">length</span>(x),<span class="dt">replace=</span><span class="ot">FALSE</span>)</span>
<span id="cb57-517"><a href="functions.html#cb57-517"></a>    })})</span>
<span id="cb57-518"><a href="functions.html#cb57-518"></a>  </span>
<span id="cb57-519"><a href="functions.html#cb57-519"></a>  <span class="co">#randomization_list&lt;-plyr::alply(randomization_array,3)</span></span>
<span id="cb57-520"><a href="functions.html#cb57-520"></a>  <span class="co"># names(randomization_list) &lt;- NULL</span></span>
<span id="cb57-521"><a href="functions.html#cb57-521"></a>  </span>
<span id="cb57-522"><a href="functions.html#cb57-522"></a>  empirical_distribution&lt;-<span class="kw">suppressMessages</span>(<span class="kw">lapply</span>(randomization_list, <span class="cf">function</span>(randomization){</span>
<span id="cb57-523"><a href="functions.html#cb57-523"></a>    randomization<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">apply</span>(randomization,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-524"><a href="functions.html#cb57-524"></a>    loop_dedup&lt;-matrix_of_interest[<span class="op">!</span><span class="kw">duplicated</span>(randomization),]</span>
<span id="cb57-525"><a href="functions.html#cb57-525"></a>    loop_clonal_architecture &lt;-<span class="st"> </span><span class="kw">melt</span>(loop_dedup)</span>
<span id="cb57-526"><a href="functions.html#cb57-526"></a>    <span class="kw">colnames</span>(loop_clonal_architecture) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb57-527"><a href="functions.html#cb57-527"></a>    loop_clonal_architecture<span class="op">$</span>Genotype &lt;-<span class="st"> </span><span class="kw">ifelse</span>(loop_clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">3</span>,<span class="ot">NA</span>,</span>
<span id="cb57-528"><a href="functions.html#cb57-528"></a>                                                <span class="kw">ifelse</span>(loop_clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb57-529"><a href="functions.html#cb57-529"></a>                                                       <span class="kw">ifelse</span>(loop_clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb57-530"><a href="functions.html#cb57-530"></a>                                                              <span class="kw">ifelse</span>(loop_clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,clonal_architecture<span class="op">$</span>Genotype))))</span>
<span id="cb57-531"><a href="functions.html#cb57-531"></a>    loop_clonal_architecture<span class="op">$</span>Genotype  &lt;-<span class="st"> </span><span class="kw">factor</span>(loop_clonal_architecture<span class="op">$</span>Genotype ,<span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>))</span>
<span id="cb57-532"><a href="functions.html#cb57-532"></a>    loop_clonal_abundance &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Count&quot;</span>=<span class="kw">as.matrix</span>(<span class="kw">table</span>(randomization<span class="op">$</span>Clone)))</span>
<span id="cb57-533"><a href="functions.html#cb57-533"></a>    loop_clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">rownames</span>(loop_clonal_abundance)</span>
<span id="cb57-534"><a href="functions.html#cb57-534"></a>    <span class="kw">return</span>(<span class="kw">data.frame</span>(loop_clonal_abundance))</span>
<span id="cb57-535"><a href="functions.html#cb57-535"></a>  }))</span>
<span id="cb57-536"><a href="functions.html#cb57-536"></a>  </span>
<span id="cb57-537"><a href="functions.html#cb57-537"></a>  </span>
<span id="cb57-538"><a href="functions.html#cb57-538"></a>  empirical_distribution_mat&lt;-empirical_distribution<span class="op">%&gt;%</span>purrr<span class="op">::</span><span class="kw">reduce</span>(dplyr<span class="op">::</span>full_join,<span class="dt">by=</span><span class="st">&quot;Clone&quot;</span>)</span>
<span id="cb57-539"><a href="functions.html#cb57-539"></a>  <span class="kw">colnames</span>(empirical_distribution_mat)&lt;-<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(<span class="kw">colnames</span>(empirical_distribution_mat))</span>
<span id="cb57-540"><a href="functions.html#cb57-540"></a>  <span class="kw">rownames</span>(empirical_distribution_mat) &lt;-<span class="st"> </span>empirical_distribution_mat[,<span class="dv">2</span>]</span>
<span id="cb57-541"><a href="functions.html#cb57-541"></a>  empirical_distribution_mat &lt;-<span class="st"> </span>empirical_distribution_mat[,<span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb57-542"><a href="functions.html#cb57-542"></a>  empirical_distribution_mat[<span class="kw">is.na</span>(empirical_distribution_mat)]&lt;-<span class="dv">0</span></span>
<span id="cb57-543"><a href="functions.html#cb57-543"></a>  </span>
<span id="cb57-544"><a href="functions.html#cb57-544"></a>  clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">as.character</span>(clonal_abundance<span class="op">$</span>Clone)</span>
<span id="cb57-545"><a href="functions.html#cb57-545"></a>  clonal_abundance<span class="op">$</span>Count &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(clonal_abundance<span class="op">$</span>Count)</span>
<span id="cb57-546"><a href="functions.html#cb57-546"></a>  clonal_abundance<span class="op">$</span>pvalue &lt;-<span class="kw">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-547"><a href="functions.html#cb57-547"></a>  <span class="dv">1</span><span class="op">-</span><span class="st">  </span><span class="kw">sum</span>(<span class="kw">as.numeric</span>(x[[<span class="st">&quot;Count&quot;</span>]])<span class="op">&gt;</span>empirical_distribution_mat[x[[<span class="st">&quot;Clone&quot;</span>]],])<span class="op">/</span>nrun</span>
<span id="cb57-548"><a href="functions.html#cb57-548"></a>    })</span>
<span id="cb57-549"><a href="functions.html#cb57-549"></a>  </span>
<span id="cb57-550"><a href="functions.html#cb57-550"></a>  </span>
<span id="cb57-551"><a href="functions.html#cb57-551"></a>  <span class="co">#print(dedup)</span></span>
<span id="cb57-552"><a href="functions.html#cb57-552"></a>  <span class="kw">colnames</span>(clonal_abundance)[<span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="kw">colnames</span>(dedup)[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(SNP_changes_of_interest)],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;__&quot;</span>)</span>
<span id="cb57-553"><a href="functions.html#cb57-553"></a>  clonal_abundance &lt;-<span class="st"> </span>clonal_abundance[<span class="kw">order</span>(clonal_abundance[,<span class="st">&quot;Count&quot;</span>],<span class="dt">decreasing =</span> <span class="ot">TRUE</span>),]</span>
<span id="cb57-554"><a href="functions.html#cb57-554"></a>  clonal_abundance<span class="op">$</span>Dominance &lt;-<span class="st"> </span><span class="kw">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-555"><a href="functions.html#cb57-555"></a>    (<span class="kw">as.numeric</span>(x[<span class="st">&quot;Count&quot;</span>])<span class="op">/</span><span class="kw">sum</span>(clonal_abundance[<span class="st">&quot;Count&quot;</span>]) ) <span class="op">/</span><span class="st"> </span>(<span class="kw">max</span>(<span class="kw">as.numeric</span>(clonal_abundance[,<span class="st">&quot;Count&quot;</span>]))<span class="op">/</span><span class="kw">sum</span>(clonal_abundance[<span class="st">&quot;Count&quot;</span>]))</span>
<span id="cb57-556"><a href="functions.html#cb57-556"></a>      })</span>
<span id="cb57-557"><a href="functions.html#cb57-557"></a>  clonal_abundance<span class="op">$</span>Poisson &lt;-<span class="st"> </span><span class="kw">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-558"><a href="functions.html#cb57-558"></a>        <span class="kw">poisson.test</span>(<span class="kw">as.numeric</span>(x[<span class="st">&quot;Count&quot;</span>]),<span class="kw">mean</span>(<span class="kw">as.numeric</span>(clonal_abundance<span class="op">$</span>Count)),<span class="dt">alternative=</span><span class="st">&quot;greater&quot;</span>)<span class="op">$</span>p.value</span>
<span id="cb57-559"><a href="functions.html#cb57-559"></a>      })</span>
<span id="cb57-560"><a href="functions.html#cb57-560"></a>  clonal_abundance<span class="op">$</span>Mutation_count &lt;-<span class="st"> </span><span class="kw">apply</span>(clonal_abundance,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-561"><a href="functions.html#cb57-561"></a>    <span class="kw">sum</span>(<span class="kw">as.numeric</span>(<span class="kw">strsplit</span>( <span class="kw">as.character</span>(x[<span class="dv">2</span>]),<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)[[<span class="dv">1</span>]]))</span>
<span id="cb57-562"><a href="functions.html#cb57-562"></a>  })</span>
<span id="cb57-563"><a href="functions.html#cb57-563"></a>  </span>
<span id="cb57-564"><a href="functions.html#cb57-564"></a>  <span class="kw">write.table</span>(clonal_abundance,<span class="kw">paste0</span>(output_folder,<span class="st">&quot;Summary_mat/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>,<span class="dt">row.names=</span><span class="ot">FALSE</span>)</span>
<span id="cb57-565"><a href="functions.html#cb57-565"></a>  </span>
<span id="cb57-566"><a href="functions.html#cb57-566"></a>}</span>
<span id="cb57-567"><a href="functions.html#cb57-567"></a></span>
<span id="cb57-568"><a href="functions.html#cb57-568"></a></span>
<span id="cb57-569"><a href="functions.html#cb57-569"></a></span>
<span id="cb57-570"><a href="functions.html#cb57-570"></a>replot_clonal_selection &lt;-<span class="st"> </span><span class="cf">function</span>(sample){</span>
<span id="cb57-571"><a href="functions.html#cb57-571"></a>  </span>
<span id="cb57-572"><a href="functions.html#cb57-572"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-573"><a href="functions.html#cb57-573"></a>    LAM_VARIANTS_MAT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-574"><a href="functions.html#cb57-574"></a>    LAM_VARIANTS_SNP &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb57-575"><a href="functions.html#cb57-575"></a>    LAM_VARIANTS_Protein &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb57-576"><a href="functions.html#cb57-576"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-577"><a href="functions.html#cb57-577"></a>    <span class="kw">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb57-578"><a href="functions.html#cb57-578"></a>    <span class="kw">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb57-579"><a href="functions.html#cb57-579"></a>  }</span>
<span id="cb57-580"><a href="functions.html#cb57-580"></a>  DP &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb57-581"><a href="functions.html#cb57-581"></a>  NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb57-582"><a href="functions.html#cb57-582"></a>  </span>
<span id="cb57-583"><a href="functions.html#cb57-583"></a>  <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-584"><a href="functions.html#cb57-584"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-585"><a href="functions.html#cb57-585"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(NGT)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-586"><a href="functions.html#cb57-586"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-587"><a href="functions.html#cb57-587"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-588"><a href="functions.html#cb57-588"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-589"><a href="functions.html#cb57-589"></a>                    <span class="kw">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-590"><a href="functions.html#cb57-590"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-591"><a href="functions.html#cb57-591"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-592"><a href="functions.html#cb57-592"></a>    SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-593"><a href="functions.html#cb57-593"></a>    <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(NGT)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-594"><a href="functions.html#cb57-594"></a>    <span class="kw">colnames</span>(SNP_INFO)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;protein&quot;</span></span>
<span id="cb57-595"><a href="functions.html#cb57-595"></a>    SNP_INFO<span class="op">$</span>cDNA &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>cDNA)</span>
<span id="cb57-596"><a href="functions.html#cb57-596"></a>    SNP_INFO<span class="op">$</span>protein &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>protein)</span>
<span id="cb57-597"><a href="functions.html#cb57-597"></a>    SNP_INFO<span class="op">$</span>Variant &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Variant)</span>
<span id="cb57-598"><a href="functions.html#cb57-598"></a>    SNP_INFO<span class="op">$</span>Gene &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Gene)</span>
<span id="cb57-599"><a href="functions.html#cb57-599"></a>    SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-600"><a href="functions.html#cb57-600"></a>      <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-601"><a href="functions.html#cb57-601"></a>             <span class="kw">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-602"><a href="functions.html#cb57-602"></a>                    <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-603"><a href="functions.html#cb57-603"></a>    })<span class="co"># - variant metadata</span></span>
<span id="cb57-604"><a href="functions.html#cb57-604"></a>  }</span>
<span id="cb57-605"><a href="functions.html#cb57-605"></a>  </span>
<span id="cb57-606"><a href="functions.html#cb57-606"></a>  SNP_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_SNP</span>
<span id="cb57-607"><a href="functions.html#cb57-607"></a>  protein_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_Protein</span>
<span id="cb57-608"><a href="functions.html#cb57-608"></a>  SNP_protein_key &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Mutant&quot;</span>=SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span>=protein_changes_of_interest)</span>
<span id="cb57-609"><a href="functions.html#cb57-609"></a>  <span class="kw">rownames</span>(SNP_protein_key) &lt;-<span class="st"> </span>SNP_protein_key<span class="op">$</span>Mutant</span>
<span id="cb57-610"><a href="functions.html#cb57-610"></a>  <span class="co"># Cell and clone selection</span></span>
<span id="cb57-611"><a href="functions.html#cb57-611"></a>  distribution_of_unknowns_by_variant &lt;-<span class="st"> </span><span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb57-612"><a href="functions.html#cb57-612"></a>  <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb57-613"><a href="functions.html#cb57-613"></a>  cells_with_unknown&lt;-NGT[<span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">1</span>,<span class="dt">FUN=</span><span class="cf">function</span>(x){<span class="kw">sum</span>(x<span class="op">==</span><span class="dv">3</span>)<span class="op">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb57-614"><a href="functions.html#cb57-614"></a>  matrix_of_interest&lt;-NGT[<span class="op">!</span>NGT<span class="op">$</span>Cell<span class="op">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb57-615"><a href="functions.html#cb57-615"></a>  bulk_VAF_order&lt;-SNP_INFO[<span class="kw">colnames</span>(matrix_of_interest)[<span class="kw">order</span>(<span class="kw">colSums</span>(matrix_of_interest),<span class="dt">decreasing=</span><span class="ot">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb57-616"><a href="functions.html#cb57-616"></a>  bulk_VAF_order &lt;-<span class="st"> </span>bulk_VAF_order[<span class="op">!</span><span class="kw">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb57-617"><a href="functions.html#cb57-617"></a>  matrix_of_interest<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-618"><a href="functions.html#cb57-618"></a>  </span>
<span id="cb57-619"><a href="functions.html#cb57-619"></a>  dedup&lt;-matrix_of_interest[<span class="op">!</span><span class="kw">duplicated</span>(matrix_of_interest),]</span>
<span id="cb57-620"><a href="functions.html#cb57-620"></a>  <span class="kw">colnames</span>(dedup) &lt;-<span class="st"> </span>SNP_protein_key[<span class="kw">colnames</span>(dedup),<span class="st">&quot;Protein&quot;</span>]</span>
<span id="cb57-621"><a href="functions.html#cb57-621"></a>  clonal_architecture &lt;-<span class="st"> </span><span class="kw">melt</span>(dedup)</span>
<span id="cb57-622"><a href="functions.html#cb57-622"></a>  <span class="kw">colnames</span>(clonal_architecture) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Clone&quot;</span>,<span class="st">&quot;Mutant&quot;</span>,<span class="st">&quot;Genotype&quot;</span>)</span>
<span id="cb57-623"><a href="functions.html#cb57-623"></a>  clonal_architecture<span class="op">$</span>Genotype &lt;-<span class="st"> </span><span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">3</span>,<span class="ot">NA</span>,</span>
<span id="cb57-624"><a href="functions.html#cb57-624"></a>                                         <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">0</span>,<span class="st">&quot;WT&quot;</span>,</span>
<span id="cb57-625"><a href="functions.html#cb57-625"></a>                                                <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">1</span>,<span class="st">&quot;Heterozygous&quot;</span>,</span>
<span id="cb57-626"><a href="functions.html#cb57-626"></a>                                                       <span class="kw">ifelse</span>(clonal_architecture<span class="op">$</span>Genotype<span class="op">==</span><span class="dv">2</span>,<span class="st">&quot;Homozygous&quot;</span>,clonal_architecture<span class="op">$</span>Genotype))))</span>
<span id="cb57-627"><a href="functions.html#cb57-627"></a>  clonal_architecture<span class="op">$</span>Genotype  &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_architecture<span class="op">$</span>Genotype ,<span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>,<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>))</span>
<span id="cb57-628"><a href="functions.html#cb57-628"></a>  clonal_abundance &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Count&quot;</span>=<span class="kw">as.matrix</span>(<span class="kw">table</span>(matrix_of_interest<span class="op">$</span>Clone)))</span>
<span id="cb57-629"><a href="functions.html#cb57-629"></a>  clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">rownames</span>(clonal_abundance)</span>
<span id="cb57-630"><a href="functions.html#cb57-630"></a>  clonal_abundance &lt;-<span class="st"> </span><span class="kw">data.table</span>(clonal_abundance,<span class="dt">key=</span><span class="st">&quot;Count&quot;</span>)</span>
<span id="cb57-631"><a href="functions.html#cb57-631"></a>  clonal_abundance<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_abundance<span class="op">$</span>Clone,<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">c</span>(clonal_abundance<span class="op">$</span>Clone)))</span>
<span id="cb57-632"><a href="functions.html#cb57-632"></a>  clonal_architecture<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">as.character</span>(clonal_architecture<span class="op">$</span>Clone),<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">as.character</span>(clonal_abundance<span class="op">$</span>Clone)))</span>
<span id="cb57-633"><a href="functions.html#cb57-633"></a>  clonal_architecture<span class="op">$</span>Mutant &lt;-<span class="kw">factor</span>(clonal_architecture<span class="op">$</span>Mutant , <span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">as.character</span>(bulk_VAF_order)))</span>
<span id="cb57-634"><a href="functions.html#cb57-634"></a>  </span>
<span id="cb57-635"><a href="functions.html#cb57-635"></a>  clones_import &lt;-<span class="st"> </span><span class="kw">read.delim</span>(<span class="kw">paste0</span>(<span class="st">&quot;/Volumes/LevineLab/Levine Lab/Bobby/Collaborations/MissionBio/08_08_19/Summary_mat/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</span>
<span id="cb57-636"><a href="functions.html#cb57-636"></a>  <span class="kw">colnames</span>(clones_import)[<span class="dv">2</span>] &lt;-<span class="st"> &quot;Clone&quot;</span></span>
<span id="cb57-637"><a href="functions.html#cb57-637"></a>  select_clones_full &lt;-<span class="st"> </span>clones_import <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(pvalue<span class="op">&lt;</span><span class="fl">0.1</span><span class="op">|</span>Poisson<span class="op">&lt;</span><span class="fl">0.05</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Clone)</span>
<span id="cb57-638"><a href="functions.html#cb57-638"></a>  select_clones_dominant &lt;-<span class="st"> </span>clones_import <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(pvalue<span class="op">&lt;</span><span class="fl">0.1</span><span class="op">|</span>Poisson<span class="op">&lt;</span><span class="fl">0.05</span>)<span class="op">%&gt;%</span><span class="kw">filter</span>(Dominance<span class="op">&gt;</span><span class="fl">0.05</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Clone)</span>
<span id="cb57-639"><a href="functions.html#cb57-639"></a></span>
<span id="cb57-640"><a href="functions.html#cb57-640"></a>  </span>
<span id="cb57-641"><a href="functions.html#cb57-641"></a>  </span>
<span id="cb57-642"><a href="functions.html#cb57-642"></a>  <span class="cf">if</span>(<span class="kw">length</span>(select_clones_dominant[,<span class="dv">1</span>])<span class="op">&gt;</span><span class="dv">3</span>){</span>
<span id="cb57-643"><a href="functions.html#cb57-643"></a>    clonal_architecture_subset &lt;-<span class="st"> </span>clonal_architecture<span class="op">%&gt;%</span><span class="kw">filter</span>(Clone<span class="op">%in%</span>select_clones_dominant[,<span class="dv">1</span>])</span>
<span id="cb57-644"><a href="functions.html#cb57-644"></a>    clonal_abundance_subset &lt;-<span class="st"> </span>clonal_abundance<span class="op">%&gt;%</span><span class="kw">filter</span>(Clone<span class="op">%in%</span>select_clones_dominant[,<span class="dv">1</span>])</span>
<span id="cb57-645"><a href="functions.html#cb57-645"></a>    name_var &lt;-<span class="st"> &quot;VAF Subset&quot;</span></span>
<span id="cb57-646"><a href="functions.html#cb57-646"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="kw">length</span>(select_clones_full[,<span class="dv">1</span>])<span class="op">&gt;</span><span class="dv">20</span>){</span>
<span id="cb57-647"><a href="functions.html#cb57-647"></a>    <span class="kw">print</span>(<span class="st">&quot;Complex clonal picture, skipping&quot;</span>)</span>
<span id="cb57-648"><a href="functions.html#cb57-648"></a>    <span class="kw">return</span>(<span class="cf">next</span>)</span>
<span id="cb57-649"><a href="functions.html#cb57-649"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="kw">length</span>(select_clones_full[,<span class="dv">1</span>])<span class="op">&lt;</span><span class="dv">2</span>){</span>
<span id="cb57-650"><a href="functions.html#cb57-650"></a>    <span class="kw">print</span>(<span class="st">&quot;Simple clonal picture, plotting all clones&quot;</span>)</span>
<span id="cb57-651"><a href="functions.html#cb57-651"></a>    clonal_architecture_subset &lt;-<span class="st"> </span>clonal_architecture</span>
<span id="cb57-652"><a href="functions.html#cb57-652"></a>    clonal_abundance_subset &lt;-<span class="st"> </span>clonal_abundance</span>
<span id="cb57-653"><a href="functions.html#cb57-653"></a>    name_var &lt;-<span class="st"> &quot;All Clones&quot;</span></span>
<span id="cb57-654"><a href="functions.html#cb57-654"></a>  } <span class="cf">else</span> {</span>
<span id="cb57-655"><a href="functions.html#cb57-655"></a>    clonal_architecture_subset &lt;-<span class="st"> </span>clonal_architecture<span class="op">%&gt;%</span><span class="kw">filter</span>(Clone<span class="op">%in%</span>select_clones_full[,<span class="dv">1</span>])</span>
<span id="cb57-656"><a href="functions.html#cb57-656"></a>    clonal_abundance_subset &lt;-<span class="st"> </span>clonal_abundance<span class="op">%&gt;%</span><span class="kw">filter</span>(Clone<span class="op">%in%</span>select_clones_full[,<span class="dv">1</span>])</span>
<span id="cb57-657"><a href="functions.html#cb57-657"></a>    name_var &lt;-<span class="st"> &quot;Full&quot;</span></span>
<span id="cb57-658"><a href="functions.html#cb57-658"></a>  }</span>
<span id="cb57-659"><a href="functions.html#cb57-659"></a>  <span class="co"># Generate clonal architecture heatmap</span></span>
<span id="cb57-660"><a href="functions.html#cb57-660"></a>  gg_heatmap &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> clonal_architecture_subset, <span class="kw">aes</span>(<span class="dt">x =</span> Clone, <span class="dt">y =</span> <span class="kw">factor</span>(Mutant), <span class="dt">fill =</span> Genotype)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-661"><a href="functions.html#cb57-661"></a><span class="st">    </span><span class="kw">geom_tile</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-662"><a href="functions.html#cb57-662"></a><span class="st">    </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb57-663"><a href="functions.html#cb57-663"></a>                               <span class="st">&quot;Heterozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb57-664"><a href="functions.html#cb57-664"></a>                               <span class="st">&quot;Homozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb57-665"><a href="functions.html#cb57-665"></a>                               <span class="st">&quot;Unknown&quot;</span>=<span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="op">+</span></span>
<span id="cb57-666"><a href="functions.html#cb57-666"></a><span class="st">    </span><span class="kw">theme_classic</span>() <span class="op">+</span></span>
<span id="cb57-667"><a href="functions.html#cb57-667"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="op">+</span></span>
<span id="cb57-668"><a href="functions.html#cb57-668"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb57-669"><a href="functions.html#cb57-669"></a>          <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(), </span>
<span id="cb57-670"><a href="functions.html#cb57-670"></a>          <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-671"><a href="functions.html#cb57-671"></a>          <span class="dt">axis.title.x=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-672"><a href="functions.html#cb57-672"></a>          <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb57-673"><a href="functions.html#cb57-673"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-674"><a href="functions.html#cb57-674"></a>  </span>
<span id="cb57-675"><a href="functions.html#cb57-675"></a>  <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb57-676"><a href="functions.html#cb57-676"></a>  gg_clonal_barplot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(clonal_abundance_subset), <span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">factor</span>(Clone), <span class="dt">y =</span> Count)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-677"><a href="functions.html#cb57-677"></a><span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="kw">aes</span>(<span class="dt">fill =</span> Count)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_gray</span>() <span class="op">+</span></span>
<span id="cb57-678"><a href="functions.html#cb57-678"></a><span class="st">    </span><span class="kw">theme_classic</span>()<span class="op">+</span></span>
<span id="cb57-679"><a href="functions.html#cb57-679"></a><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="kw">max</span>(clonal_abundance<span class="op">$</span>Count)<span class="op">*</span><span class="fl">1.3</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-680"><a href="functions.html#cb57-680"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="op">+</span></span>
<span id="cb57-681"><a href="functions.html#cb57-681"></a><span class="st">    </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label=</span>Count), <span class="dt">position=</span><span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="fl">0.9</span>), <span class="dt">vjust=</span><span class="op">-</span><span class="fl">0.25</span>)<span class="op">+</span></span>
<span id="cb57-682"><a href="functions.html#cb57-682"></a><span class="st">    </span><span class="kw">scale_fill_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Reds&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb57-683"><a href="functions.html#cb57-683"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(),  <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-684"><a href="functions.html#cb57-684"></a>          <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb57-685"><a href="functions.html#cb57-685"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="op">-</span><span class="fl">0.2</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-686"><a href="functions.html#cb57-686"></a></span>
<span id="cb57-687"><a href="functions.html#cb57-687"></a>  <span class="co"># Compute spacing of graphs</span></span>
<span id="cb57-688"><a href="functions.html#cb57-688"></a>  plots &lt;-<span class="st"> </span><span class="kw">list</span>(gg_clonal_barplot,gg_heatmap)</span>
<span id="cb57-689"><a href="functions.html#cb57-689"></a>  grobs &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb57-690"><a href="functions.html#cb57-690"></a>  widths &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb57-691"><a href="functions.html#cb57-691"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(plots)){</span>
<span id="cb57-692"><a href="functions.html#cb57-692"></a>    grobs[[i]] &lt;-<span class="st"> </span><span class="kw">ggplotGrob</span>(plots[[i]])</span>
<span id="cb57-693"><a href="functions.html#cb57-693"></a>    widths[[i]] &lt;-<span class="st"> </span>grobs[[i]]<span class="op">$</span>widths[<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>]</span>
<span id="cb57-694"><a href="functions.html#cb57-694"></a>  }</span>
<span id="cb57-695"><a href="functions.html#cb57-695"></a>  maxwidth &lt;-<span class="st"> </span><span class="kw">do.call</span>(grid<span class="op">::</span>unit.pmax, widths)</span>
<span id="cb57-696"><a href="functions.html#cb57-696"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(grobs)){</span>
<span id="cb57-697"><a href="functions.html#cb57-697"></a>    grobs[[i]]<span class="op">$</span>widths[<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>] &lt;-<span class="st"> </span><span class="kw">as.list</span>(maxwidth)</span>
<span id="cb57-698"><a href="functions.html#cb57-698"></a>  }</span>
<span id="cb57-699"><a href="functions.html#cb57-699"></a>  </span>
<span id="cb57-700"><a href="functions.html#cb57-700"></a>  <span class="co"># Generate plot</span></span>
<span id="cb57-701"><a href="functions.html#cb57-701"></a>  grob.title &lt;-<span class="st"> </span><span class="kw">textGrob</span>(<span class="kw">paste</span>(sample,<span class="st">&quot;-&quot;</span>,name_var), <span class="dt">hjust =</span> <span class="fl">0.5</span>, <span class="dt">vjust =</span> <span class="fl">0.5</span>, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">20</span>))</span>
<span id="cb57-702"><a href="functions.html#cb57-702"></a>  <span class="kw">pdf</span>(<span class="kw">paste</span>(output_folder,<span class="st">&quot;Graphs_significant/&quot;</span>,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>), <span class="dt">width =</span> <span class="dv">16</span>, <span class="dt">height =</span> <span class="dv">8</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb57-703"><a href="functions.html#cb57-703"></a>  <span class="kw">grid.arrange</span>(<span class="dt">grobs=</span>grobs, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">top =</span> grob.title)</span>
<span id="cb57-704"><a href="functions.html#cb57-704"></a>  <span class="kw">graphics.off</span>()</span>
<span id="cb57-705"><a href="functions.html#cb57-705"></a></span>
<span id="cb57-706"><a href="functions.html#cb57-706"></a>}</span>
<span id="cb57-707"><a href="functions.html#cb57-707"></a></span>
<span id="cb57-708"><a href="functions.html#cb57-708"></a></span>
<span id="cb57-709"><a href="functions.html#cb57-709"></a>plot_clonal_heatmap_and_barplot &lt;-<span class="cf">function</span>(sample,output_folder,clonal_abundance,clonal_architecture,clone_cell_count,shrink)</span>
<span id="cb57-710"><a href="functions.html#cb57-710"></a>{</span>
<span id="cb57-711"><a href="functions.html#cb57-711"></a>  <span class="co">#clonal_abundance_subset &lt;-data.frame( clonal_abundance[[sample]])%&gt;%filter(Count&gt;=5)</span></span>
<span id="cb57-712"><a href="functions.html#cb57-712"></a>  <span class="co">#clonal_architecture_subset &lt;- data.frame(clonal_architecture[[sample]])%&gt;%</span></span>
<span id="cb57-713"><a href="functions.html#cb57-713"></a>   <span class="co">#                                         filter(Clone%in%as.character(clonal_abundance_subset$Clone))</span></span>
<span id="cb57-714"><a href="functions.html#cb57-714"></a>  clonal_abundance_subset&lt;-final_sample_summary[[sample]]<span class="op">$</span>Clones<span class="co">#clonal_abundance</span></span>
<span id="cb57-715"><a href="functions.html#cb57-715"></a>  clonal_abundance_subset<span class="op">$</span>Clone&lt;-<span class="kw">factor</span>(final_sample_summary[[sample]]<span class="op">$</span>Clones[,<span class="st">&quot;Clone&quot;</span>],<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">c</span>(final_sample_summary[[sample]]<span class="op">$</span>Clones[,<span class="st">&quot;Clone&quot;</span>])))<span class="co">#clonal_abundance</span></span>
<span id="cb57-716"><a href="functions.html#cb57-716"></a>  clonal_architecture_subset&lt;-final_sample_summary[[sample]]<span class="op">$</span>Architecture<span class="op">%&gt;%</span></span>
<span id="cb57-717"><a href="functions.html#cb57-717"></a><span class="st">                                      </span><span class="kw">filter</span>(Clone<span class="op">%in%</span><span class="kw">as.character</span>(clonal_abundance_subset<span class="op">$</span>Clone))</span>
<span id="cb57-718"><a href="functions.html#cb57-718"></a>  </span>
<span id="cb57-719"><a href="functions.html#cb57-719"></a>  clonal_architecture_subset<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_architecture_subset<span class="op">$</span>Clone, <span class="dt">levels=</span><span class="kw">levels</span>(clonal_abundance_subset<span class="op">$</span>Clone))</span>
<span id="cb57-720"><a href="functions.html#cb57-720"></a>  gg_heatmap &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> clonal_architecture_subset, <span class="kw">aes</span>(<span class="dt">x =</span> Clone, <span class="dt">y =</span> <span class="kw">factor</span>(Mutant,<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">levels</span>(<span class="kw">factor</span>(Mutant)))), <span class="dt">fill =</span> Genotype)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-721"><a href="functions.html#cb57-721"></a><span class="st">    </span><span class="kw">geom_tile</span>() <span class="op">+</span><span class="co"># scale_y_discrete(limits = rev(levels(Mutant)))+</span></span>
<span id="cb57-722"><a href="functions.html#cb57-722"></a></span>
<span id="cb57-723"><a href="functions.html#cb57-723"></a><span class="st">    </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb57-724"><a href="functions.html#cb57-724"></a>                               <span class="st">&quot;Heterozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb57-725"><a href="functions.html#cb57-725"></a>                               <span class="st">&quot;Homozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb57-726"><a href="functions.html#cb57-726"></a>                               <span class="st">&quot;Unknown&quot;</span>=<span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="op">+</span></span>
<span id="cb57-727"><a href="functions.html#cb57-727"></a><span class="st">    </span><span class="kw">theme_classic</span>(<span class="dt">base_size=</span><span class="dv">6</span>) <span class="op">+</span></span>
<span id="cb57-728"><a href="functions.html#cb57-728"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="op">+</span></span>
<span id="cb57-729"><a href="functions.html#cb57-729"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb57-730"><a href="functions.html#cb57-730"></a>          <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(), </span>
<span id="cb57-731"><a href="functions.html#cb57-731"></a>          <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-732"><a href="functions.html#cb57-732"></a>          <span class="dt">axis.title.x=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-733"><a href="functions.html#cb57-733"></a>          <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb57-734"><a href="functions.html#cb57-734"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-735"><a href="functions.html#cb57-735"></a>  </span>
<span id="cb57-736"><a href="functions.html#cb57-736"></a>  <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb57-737"><a href="functions.html#cb57-737"></a>  gg_clonal_barplot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(clonal_abundance_subset), <span class="kw">aes</span>(<span class="dt">x =</span> Clone, <span class="dt">y =</span> Count)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-738"><a href="functions.html#cb57-738"></a><span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="kw">aes</span>(<span class="dt">fill =</span> Count)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_gray</span>() <span class="op">+</span></span>
<span id="cb57-739"><a href="functions.html#cb57-739"></a><span class="st">    </span><span class="kw">theme_classic</span>(<span class="dt">base_size=</span><span class="dv">6</span>)<span class="op">+</span></span>
<span id="cb57-740"><a href="functions.html#cb57-740"></a><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="kw">max</span>(clonal_abundance_subset<span class="op">$</span>Count)<span class="op">*</span><span class="fl">1.3</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-741"><a href="functions.html#cb57-741"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="op">+</span></span>
<span id="cb57-742"><a href="functions.html#cb57-742"></a><span class="st">    </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label=</span>Count), <span class="dt">position=</span><span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="fl">0.9</span>), <span class="dt">vjust=</span><span class="op">-</span><span class="fl">0.25</span>,<span class="dt">size=</span><span class="dv">1</span>)<span class="op">+</span></span>
<span id="cb57-743"><a href="functions.html#cb57-743"></a><span class="st">    </span><span class="kw">scale_fill_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Reds&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb57-744"><a href="functions.html#cb57-744"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(),  <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-745"><a href="functions.html#cb57-745"></a>          <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb57-746"><a href="functions.html#cb57-746"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="op">-</span><span class="fl">0.2</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-747"><a href="functions.html#cb57-747"></a>  </span>
<span id="cb57-748"><a href="functions.html#cb57-748"></a>  grob.title &lt;-<span class="st"> </span><span class="kw">textGrob</span>(<span class="kw">paste</span>(sample,<span class="st">&quot;-&quot;</span>), <span class="dt">hjust=</span> <span class="fl">0.5</span>, <span class="dt">vjust =</span> <span class="fl">0.5</span>, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">12</span>))</span>
<span id="cb57-749"><a href="functions.html#cb57-749"></a>  final_plot&lt;-<span class="kw">plot_grid</span>(grob.title,gg_clonal_barplot,gg_heatmap,<span class="dt">ncol=</span><span class="dv">1</span>,<span class="dt">align=</span><span class="st">&quot;hv&quot;</span>,<span class="dt">axis=</span><span class="st">&quot;l&quot;</span>,<span class="dt">rel_heights =</span> <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="fl">0.75</span>))</span>
<span id="cb57-750"><a href="functions.html#cb57-750"></a> </span>
<span id="cb57-751"><a href="functions.html#cb57-751"></a>   <span class="kw">save_plot</span>(<span class="kw">paste</span>(output_folder,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),final_plot, <span class="dt">ncol=</span><span class="dv">1</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb57-752"><a href="functions.html#cb57-752"></a>}</span>
<span id="cb57-753"><a href="functions.html#cb57-753"></a></span>
<span id="cb57-754"><a href="functions.html#cb57-754"></a>generate_and_plot_cooccurence &lt;-<span class="st"> </span><span class="cf">function</span>(mut_mat){</span>
<span id="cb57-755"><a href="functions.html#cb57-755"></a>  cooccur_mat &lt;-<span class="st"> </span><span class="kw">cooccur</span>(<span class="dt">mat=</span><span class="kw">t</span>(mut_mat),<span class="dt">type=</span><span class="st">&quot;spp_site&quot;</span>,<span class="dt">only_effects =</span> <span class="ot">FALSE</span>,<span class="dt">eff_matrix=</span><span class="ot">TRUE</span>,<span class="dt">thresh=</span><span class="ot">FALSE</span>,<span class="dt">eff_standard=</span><span class="ot">FALSE</span>,<span class="dt">spp_names=</span><span class="ot">TRUE</span>)<span class="op">$</span>results</span>
<span id="cb57-756"><a href="functions.html#cb57-756"></a>  cooccur_mat<span class="op">$</span>score&lt;-<span class="st">  </span><span class="kw">ifelse</span>(cooccur_mat[,<span class="st">&quot;p_lt&quot;</span>]<span class="op">&lt;=</span><span class="fl">0.05</span>,<span class="op">-</span><span class="dv">1</span>,<span class="kw">ifelse</span>(cooccur_mat[,<span class="st">&quot;p_gt&quot;</span>]<span class="op">&lt;=</span><span class="fl">0.05</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb57-757"><a href="functions.html#cb57-757"></a>  cooccur_mat_subset &lt;-<span class="st"> </span><span class="kw">rbind</span>(cooccur_mat[,<span class="kw">c</span>(<span class="st">&quot;sp1_name&quot;</span>,<span class="st">&quot;sp2_name&quot;</span>,<span class="st">&quot;score&quot;</span>)],<span class="kw">c</span>(<span class="kw">setdiff</span>(cooccur_mat<span class="op">$</span>sp2_name,cooccur_mat<span class="op">$</span>sp1_name),<span class="kw">setdiff</span>(cooccur_mat<span class="op">$</span>sp1_name,cooccur_mat<span class="op">$</span>sp2_name),<span class="dv">0</span>))</span>
<span id="cb57-758"><a href="functions.html#cb57-758"></a>  cooccur_data_mat &lt;-<span class="st"> </span><span class="kw">dcast</span>(cooccur_mat_subset, sp1_name  <span class="op">~</span><span class="st"> </span>sp2_name, <span class="dt">value.var=</span><span class="st">&quot;score&quot;</span>)</span>
<span id="cb57-759"><a href="functions.html#cb57-759"></a>  <span class="kw">rownames</span>(cooccur_data_mat) &lt;-<span class="st"> </span>cooccur_data_mat[,<span class="dv">1</span>]</span>
<span id="cb57-760"><a href="functions.html#cb57-760"></a>  cooccur_data_mat2&lt;-cooccur_data_mat[,<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb57-761"><a href="functions.html#cb57-761"></a>  cooccur_data_mat2[<span class="kw">is.na</span>(cooccur_data_mat2)]&lt;-<span class="dv">0</span></span>
<span id="cb57-762"><a href="functions.html#cb57-762"></a>  cooccur_data_mat2[<span class="kw">lower.tri</span>(cooccur_data_mat2)]&lt;-<span class="ot">NA</span></span>
<span id="cb57-763"><a href="functions.html#cb57-763"></a>  cooccur_data_mat2<span class="op">$</span>Gene &lt;-<span class="st"> </span><span class="kw">rownames</span>(cooccur_data_mat2)</span>
<span id="cb57-764"><a href="functions.html#cb57-764"></a>  cooccur_data_mat_melt &lt;-<span class="st"> </span><span class="kw">na.omit</span>(<span class="kw">melt</span>(cooccur_data_mat2, <span class="st">&#39;Gene&#39;</span>, <span class="dt">variable_name=</span><span class="st">&#39;Gene2&#39;</span>))</span>
<span id="cb57-765"><a href="functions.html#cb57-765"></a>  cooccur_data_mat_melt<span class="op">$</span>variable &lt;-<span class="st"> </span><span class="kw">factor</span>(cooccur_data_mat_melt<span class="op">$</span>variable, <span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">levels</span>(cooccur_data_mat_melt<span class="op">$</span>variable)))</span>
<span id="cb57-766"><a href="functions.html#cb57-766"></a>  </span>
<span id="cb57-767"><a href="functions.html#cb57-767"></a>  </span>
<span id="cb57-768"><a href="functions.html#cb57-768"></a>  <span class="co"># Triangle heatmap to compare cohorts</span></span>
<span id="cb57-769"><a href="functions.html#cb57-769"></a>  grob_corrplot&lt;-<span class="kw">ggplot</span>(cooccur_data_mat_melt, <span class="kw">aes</span>(Gene, variable))<span class="op">+</span></span>
<span id="cb57-770"><a href="functions.html#cb57-770"></a><span class="st">    </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw">factor</span>(value)), <span class="dt">color=</span><span class="st">&#39;grey90&#39;</span>) <span class="op">+</span></span>
<span id="cb57-771"><a href="functions.html#cb57-771"></a><span class="st">    </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;-1&quot;</span>=<span class="st">&quot;firebrick3&quot;</span>,<span class="st">&quot;0&quot;</span>=<span class="st">&quot;white&quot;</span>,<span class="st">&quot;1&quot;</span>=<span class="st">&quot;steelblue2&quot;</span>),<span class="st">&quot;Correlation&quot;</span>,</span>
<span id="cb57-772"><a href="functions.html#cb57-772"></a>                      <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">&quot;Mutually Exclusive&quot;</span>,<span class="st">&quot;Not Significant&quot;</span>,<span class="st">&quot;Mutually Inclusive&quot;</span>))<span class="op">+</span></span>
<span id="cb57-773"><a href="functions.html#cb57-773"></a><span class="st">    </span><span class="kw">theme_classic</span>(<span class="dt">base_size=</span><span class="dv">10</span>)<span class="op">+</span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>)<span class="op">+</span><span class="kw">ylab</span>(<span class="st">&quot;&quot;</span>)<span class="op">+</span></span>
<span id="cb57-774"><a href="functions.html#cb57-774"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x=</span><span class="kw">element_text</span>(<span class="dt">angle=</span><span class="dv">45</span>,<span class="dt">hjust=</span><span class="dv">1</span>,<span class="dt">vjust=</span><span class="dv">1</span>),</span>
<span id="cb57-775"><a href="functions.html#cb57-775"></a>          <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb57-776"><a href="functions.html#cb57-776"></a>          <span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="fl">0.8</span>,<span class="dv">1</span>), </span>
<span id="cb57-777"><a href="functions.html#cb57-777"></a>          <span class="dt">legend.justification =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb57-778"><a href="functions.html#cb57-778"></a>          <span class="dt">legend.direction =</span> <span class="st">&quot;vertical&quot;</span>)<span class="op">+</span></span>
<span id="cb57-779"><a href="functions.html#cb57-779"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.key.size =</span> <span class="kw">unit</span>(<span class="fl">0.5</span>,<span class="st">&quot;line&quot;</span>))</span>
<span id="cb57-780"><a href="functions.html#cb57-780"></a>  <span class="kw">return</span>(<span class="kw">list</span>(<span class="st">&quot;plot&quot;</span>=grob_corrplot,</span>
<span id="cb57-781"><a href="functions.html#cb57-781"></a>         <span class="st">&quot;data&quot;</span>=cooccur_mat))</span>
<span id="cb57-782"><a href="functions.html#cb57-782"></a>}</span>
<span id="cb57-783"><a href="functions.html#cb57-783"></a></span>
<span id="cb57-784"><a href="functions.html#cb57-784"></a>diversity_from_bulk_VAF &lt;-<span class="st"> </span><span class="cf">function</span>(sample){</span>
<span id="cb57-785"><a href="functions.html#cb57-785"></a>    <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;VARIANT_SELECTION_LAM&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-786"><a href="functions.html#cb57-786"></a>      LAM_VARIANTS_MAT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_VARIANT_SELECTION_LAM.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-787"><a href="functions.html#cb57-787"></a>      LAM_VARIANTS_SNP &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Mutant))[,<span class="dv">1</span>])</span>
<span id="cb57-788"><a href="functions.html#cb57-788"></a>      LAM_VARIANTS_Protein &lt;-<span class="st"> </span><span class="kw">as.character</span>((LAM_VARIANTS_MAT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Include<span class="op">==</span><span class="st">&quot;Include&quot;</span>)<span class="op">%&gt;%</span><span class="kw">select</span>(Protein))[,<span class="dv">1</span>])</span>
<span id="cb57-789"><a href="functions.html#cb57-789"></a>    } <span class="cf">else</span> {</span>
<span id="cb57-790"><a href="functions.html#cb57-790"></a>      <span class="kw">print</span>(<span class="st">&quot;No variant selection performed!&quot;</span>) </span>
<span id="cb57-791"><a href="functions.html#cb57-791"></a>      <span class="kw">return</span>(<span class="st">&quot;next&quot;</span>)</span>
<span id="cb57-792"><a href="functions.html#cb57-792"></a>    }</span>
<span id="cb57-793"><a href="functions.html#cb57-793"></a>    <span class="co">#AF &lt;- read.csv(paste(&quot;./&quot;,sample,&quot;/&quot;,&quot;AF.csv&quot;,sep=&quot;&quot;))                    # - variant allele frequency</span></span>
<span id="cb57-794"><a href="functions.html#cb57-794"></a>    <span class="co">#DP &lt;- read.csv(paste(&quot;./&quot;,sample,&quot;/&quot;,&quot;DP.csv&quot;,sep=&quot;&quot;))                     # - read depth</span></span>
<span id="cb57-795"><a href="functions.html#cb57-795"></a>    <span class="co">#GQ &lt;- read.csv(paste(&quot;./&quot;,sample,&quot;/&quot;,&quot;GQ.csv&quot;,sep=&quot;&quot;))                    # - quality scores</span></span>
<span id="cb57-796"><a href="functions.html#cb57-796"></a>    NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb57-797"><a href="functions.html#cb57-797"></a>    </span>
<span id="cb57-798"><a href="functions.html#cb57-798"></a>    <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">grepl</span>(<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="kw">list.files</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))))){</span>
<span id="cb57-799"><a href="functions.html#cb57-799"></a>      SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>)) </span>
<span id="cb57-800"><a href="functions.html#cb57-800"></a>      <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(NGT)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-801"><a href="functions.html#cb57-801"></a>      SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-802"><a href="functions.html#cb57-802"></a>        <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-803"><a href="functions.html#cb57-803"></a>               <span class="kw">ifelse</span>(x[<span class="st">&quot;cdna&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;gene&quot;</span>],x[<span class="st">&quot;cdna&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-804"><a href="functions.html#cb57-804"></a>                      <span class="kw">ifelse</span>(x[<span class="st">&quot;amplicon&quot;</span>]<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;MSK_RL_AMP54&quot;</span>, <span class="st">&quot;MSK_RL_AMP55&quot;</span>, <span class="st">&quot;MSK_RL_AMP56&quot;</span>,<span class="st">&quot;MSK_RL_AMP57&quot;</span>,<span class="st">&quot;MSK_RL_AMP58&quot;</span>),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;POS&quot;</span>],x[<span class="st">&quot;ALT&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-805"><a href="functions.html#cb57-805"></a>      })<span class="co"># - variant metadata</span></span>
<span id="cb57-806"><a href="functions.html#cb57-806"></a>    } <span class="cf">else</span> {</span>
<span id="cb57-807"><a href="functions.html#cb57-807"></a>      SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;Variants.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))  </span>
<span id="cb57-808"><a href="functions.html#cb57-808"></a>      <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(NGT)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-809"><a href="functions.html#cb57-809"></a>      <span class="kw">colnames</span>(SNP_INFO)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;protein&quot;</span></span>
<span id="cb57-810"><a href="functions.html#cb57-810"></a>      SNP_INFO<span class="op">$</span>cDNA &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>cDNA)</span>
<span id="cb57-811"><a href="functions.html#cb57-811"></a>      SNP_INFO<span class="op">$</span>protein &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>protein)</span>
<span id="cb57-812"><a href="functions.html#cb57-812"></a>      SNP_INFO<span class="op">$</span>Variant &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Variant)</span>
<span id="cb57-813"><a href="functions.html#cb57-813"></a>      SNP_INFO<span class="op">$</span>Gene &lt;-<span class="st"> </span><span class="kw">as.character</span>(SNP_INFO<span class="op">$</span>Gene)</span>
<span id="cb57-814"><a href="functions.html#cb57-814"></a>      SNP_INFO[,<span class="kw">c</span>(<span class="st">&quot;protein&quot;</span>)] &lt;-<span class="st"> </span><span class="kw">apply</span>(SNP_INFO,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-815"><a href="functions.html#cb57-815"></a>        <span class="kw">ifelse</span>(x[<span class="st">&quot;protein&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,x[<span class="st">&quot;protein&quot;</span>],</span>
<span id="cb57-816"><a href="functions.html#cb57-816"></a>               <span class="kw">ifelse</span>(x[<span class="st">&quot;cDNA&quot;</span>]<span class="op">!=</span><span class="st">&quot;&quot;</span>,<span class="kw">paste</span>(x[<span class="st">&quot;Gene&quot;</span>],x[<span class="st">&quot;cDNA&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),</span>
<span id="cb57-817"><a href="functions.html#cb57-817"></a>                      <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;^chr13&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>]),<span class="kw">paste</span>(<span class="st">&quot;FLT3_INS&quot;</span>,x[<span class="st">&quot;Variant&quot;</span>],<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>),<span class="st">&quot;&quot;</span>)))</span>
<span id="cb57-818"><a href="functions.html#cb57-818"></a>      })<span class="co"># - variant metadata</span></span>
<span id="cb57-819"><a href="functions.html#cb57-819"></a>    }</span>
<span id="cb57-820"><a href="functions.html#cb57-820"></a>    </span>
<span id="cb57-821"><a href="functions.html#cb57-821"></a>    SNP_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_SNP</span>
<span id="cb57-822"><a href="functions.html#cb57-822"></a>    protein_changes_of_interest &lt;-<span class="st"> </span>LAM_VARIANTS_Protein</span>
<span id="cb57-823"><a href="functions.html#cb57-823"></a>    SNP_protein_key &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;Mutant&quot;</span>=SNP_changes_of_interest,<span class="st">&quot;Protein&quot;</span>=protein_changes_of_interest)</span>
<span id="cb57-824"><a href="functions.html#cb57-824"></a>    </span>
<span id="cb57-825"><a href="functions.html#cb57-825"></a>    <span class="co"># Cell and clone selection</span></span>
<span id="cb57-826"><a href="functions.html#cb57-826"></a>    distribution_of_unknowns_by_variant &lt;-<span class="st"> </span><span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">2</span>,table)</span>
<span id="cb57-827"><a href="functions.html#cb57-827"></a>    <span class="co">#print(distribution_of_unknowns_by_variant)</span></span>
<span id="cb57-828"><a href="functions.html#cb57-828"></a>    cells_with_unknown&lt;-NGT[<span class="kw">apply</span>(NGT[,SNP_changes_of_interest],<span class="dt">MARGIN=</span><span class="dv">1</span>,<span class="dt">FUN=</span><span class="cf">function</span>(x){<span class="kw">sum</span>(x<span class="op">==</span><span class="dv">3</span>)<span class="op">&gt;</span><span class="dv">0</span>}),<span class="st">&quot;Cell&quot;</span>]</span>
<span id="cb57-829"><a href="functions.html#cb57-829"></a>    matrix_of_interest&lt;-NGT[<span class="op">!</span>NGT<span class="op">$</span>Cell<span class="op">%in%</span>cells_with_unknown,SNP_changes_of_interest]</span>
<span id="cb57-830"><a href="functions.html#cb57-830"></a>    bulk_VAF_order&lt;-SNP_INFO[<span class="kw">colnames</span>(matrix_of_interest)[<span class="kw">order</span>(<span class="kw">colSums</span>(matrix_of_interest),<span class="dt">decreasing=</span><span class="ot">TRUE</span>)],<span class="st">&quot;protein&quot;</span>]</span>
<span id="cb57-831"><a href="functions.html#cb57-831"></a>    bulk_VAF_order &lt;-<span class="st"> </span>bulk_VAF_order[<span class="op">!</span><span class="kw">duplicated</span>(bulk_VAF_order)]</span>
<span id="cb57-832"><a href="functions.html#cb57-832"></a>    matrix_of_interest<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">apply</span>(matrix_of_interest,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-833"><a href="functions.html#cb57-833"></a>    </span>
<span id="cb57-834"><a href="functions.html#cb57-834"></a>    output&lt;-<span class="kw">diversity</span>(<span class="kw">colSums</span>(matrix_of_interest[<span class="kw">colnames</span>(matrix_of_interest)<span class="op">!=</span><span class="st">&quot;Clone&quot;</span>])<span class="op">/</span><span class="kw">length</span>(<span class="kw">rownames</span>(matrix_of_interest)))</span>
<span id="cb57-835"><a href="functions.html#cb57-835"></a>    <span class="kw">write.table</span>(output,<span class="kw">paste0</span>(output_folder,<span class="st">&quot;Diversity_score_faux_VAF/&quot;</span>,sample,<span class="st">&quot;.txt&quot;</span>),<span class="dt">sep=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</span>
<span id="cb57-836"><a href="functions.html#cb57-836"></a>  </span>
<span id="cb57-837"><a href="functions.html#cb57-837"></a>}</span>
<span id="cb57-838"><a href="functions.html#cb57-838"></a></span>
<span id="cb57-839"><a href="functions.html#cb57-839"></a><span class="co">## Old Functions</span></span>
<span id="cb57-840"><a href="functions.html#cb57-840"></a>plot_variants_AF_and_DP &lt;-<span class="st"> </span><span class="cf">function</span>(sample){</span>
<span id="cb57-841"><a href="functions.html#cb57-841"></a>  </span>
<span id="cb57-842"><a href="functions.html#cb57-842"></a>  <span class="co">#Load in the data</span></span>
<span id="cb57-843"><a href="functions.html#cb57-843"></a>  AF &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;AF.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - variant allele frequency</span></span>
<span id="cb57-844"><a href="functions.html#cb57-844"></a>  DP &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;DP.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                     <span class="co"># - read depth</span></span>
<span id="cb57-845"><a href="functions.html#cb57-845"></a>  GQ &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;GQ.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                    <span class="co"># - quality scores</span></span>
<span id="cb57-846"><a href="functions.html#cb57-846"></a>  NGT &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;NGT.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))                 <span class="co"># - genotype call converted to categorical (0-reference, 1-heterozygous mutation, 2-homozygous mutation, 3-unknown)</span></span>
<span id="cb57-847"><a href="functions.html#cb57-847"></a>  SNP_INFO &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">paste</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,<span class="st">&quot;SNP_INFO.csv&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))         <span class="co"># - variant metadata</span></span>
<span id="cb57-848"><a href="functions.html#cb57-848"></a>  <span class="kw">rownames</span>(SNP_INFO) &lt;-<span class="kw">colnames</span>(AF)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)]  <span class="co"># - renames SNP info to have the variants as rownames</span></span>
<span id="cb57-849"><a href="functions.html#cb57-849"></a>  </span>
<span id="cb57-850"><a href="functions.html#cb57-850"></a>  AF_NGT_Melt&lt;-<span class="kw">inner_join</span>(AF <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="kw">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>)) <span class="op">%&gt;%</span><span class="kw">melt</span>(<span class="st">&quot;Sample_cell&quot;</span>),</span>
<span id="cb57-851"><a href="functions.html#cb57-851"></a>                          NGT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="kw">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>)) <span class="op">%&gt;%</span><span class="kw">melt</span>(<span class="st">&quot;Sample_cell&quot;</span>),</span>
<span id="cb57-852"><a href="functions.html#cb57-852"></a>                          <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="st">&quot;variable&quot;</span>))</span>
<span id="cb57-853"><a href="functions.html#cb57-853"></a>  <span class="kw">colnames</span>(AF_NGT_Melt) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;Variant&quot;</span>,<span class="st">&quot;AF&quot;</span>,<span class="st">&quot;NGT&quot;</span>)</span>
<span id="cb57-854"><a href="functions.html#cb57-854"></a>  gg_AF_NGT&lt;-<span class="st">  </span><span class="kw">ggplot</span>(AF_NGT_Melt,<span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">as.factor</span>(NGT),<span class="dt">y=</span>AF,<span class="dt">color=</span>NGT))<span class="op">+</span><span class="st"> </span><span class="kw">geom_quasirandom</span>()<span class="op">+</span><span class="kw">facet_wrap</span>(<span class="op">~</span>Variant,<span class="dt">ncol=</span><span class="dv">3</span>)</span>
<span id="cb57-855"><a href="functions.html#cb57-855"></a>  </span>
<span id="cb57-856"><a href="functions.html#cb57-856"></a>  DP_NGT_Melt&lt;-<span class="kw">inner_join</span>(DP <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="kw">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>)) <span class="op">%&gt;%</span><span class="kw">melt</span>(<span class="st">&quot;Sample_cell&quot;</span>),</span>
<span id="cb57-857"><a href="functions.html#cb57-857"></a>                          NGT <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unite</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="kw">c</span>(<span class="st">&quot;Sample&quot;</span>,<span class="st">&quot;Cell&quot;</span>)) <span class="op">%&gt;%</span><span class="kw">melt</span>(<span class="st">&quot;Sample_cell&quot;</span>),</span>
<span id="cb57-858"><a href="functions.html#cb57-858"></a>                          <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;Sample_cell&quot;</span>,<span class="st">&quot;variable&quot;</span>))</span>
<span id="cb57-859"><a href="functions.html#cb57-859"></a>  <span class="kw">colnames</span>(DP_NGT_Melt) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Cell&quot;</span>,<span class="st">&quot;Variant&quot;</span>,<span class="st">&quot;DP&quot;</span>,<span class="st">&quot;NGT&quot;</span>)</span>
<span id="cb57-860"><a href="functions.html#cb57-860"></a>  gg_DP_NGT&lt;-<span class="st"> </span><span class="kw">ggplot</span>(DP_NGT_Melt,<span class="kw">aes</span>(<span class="dt">x=</span><span class="kw">as.factor</span>(NGT),<span class="dt">y=</span>DP,<span class="dt">fill=</span>NGT))<span class="op">+</span><span class="kw">geom_boxplot</span>()<span class="op">+</span><span class="kw">facet_wrap</span>(<span class="op">~</span>Variant,<span class="dt">ncol=</span><span class="dv">3</span>,<span class="dt">scale=</span><span class="st">&quot;free_y&quot;</span>)</span>
<span id="cb57-861"><a href="functions.html#cb57-861"></a>  </span>
<span id="cb57-862"><a href="functions.html#cb57-862"></a>  </span>
<span id="cb57-863"><a href="functions.html#cb57-863"></a>  <span class="kw">ggsave</span>(<span class="kw">paste0</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_DP_NGT.pdf&quot;</span>),gg_DP_NGT,<span class="dt">width=</span><span class="dv">10</span>,<span class="dt">height=</span><span class="dv">40</span>)</span>
<span id="cb57-864"><a href="functions.html#cb57-864"></a>  <span class="kw">ggsave</span>(<span class="kw">paste0</span>(<span class="st">&quot;./&quot;</span>,sample,<span class="st">&quot;/&quot;</span>,sample,<span class="st">&quot;_AF_NGT.pdf&quot;</span>),gg_AF_NGT,<span class="dt">width=</span><span class="dv">10</span>,<span class="dt">height=</span><span class="dv">40</span>)</span>
<span id="cb57-865"><a href="functions.html#cb57-865"></a>  </span>
<span id="cb57-866"><a href="functions.html#cb57-866"></a>}</span>
<span id="cb57-867"><a href="functions.html#cb57-867"></a></span>
<span id="cb57-868"><a href="functions.html#cb57-868"></a></span>
<span id="cb57-869"><a href="functions.html#cb57-869"></a>plot_COMPASS_data &lt;-<span class="cf">function</span>(sample,output_folder,melted_protein_mat,clonal_abundance,clonal_architecture,clone_cell_count,shrink)</span>
<span id="cb57-870"><a href="functions.html#cb57-870"></a>  {</span>
<span id="cb57-871"><a href="functions.html#cb57-871"></a>  melted_protein_mat &lt;-melted_protein_mat[[sample]]</span>
<span id="cb57-872"><a href="functions.html#cb57-872"></a>    clonal_abundance_subset &lt;-<span class="kw">data.frame</span>( clonal_abundance[[sample]])<span class="co">#%&gt;%filter(Count&gt;=5)</span></span>
<span id="cb57-873"><a href="functions.html#cb57-873"></a>    clonal_architecture_subset &lt;-<span class="st"> </span><span class="kw">data.frame</span>(clonal_architecture[[sample]])<span class="co">#%&gt;%</span></span>
<span id="cb57-874"><a href="functions.html#cb57-874"></a>    <span class="co">#  filter(Clone%in%as.character(clonal_abundance_subset$Clone))</span></span>
<span id="cb57-875"><a href="functions.html#cb57-875"></a>    genes_to_display &lt;-<span class="kw">unique</span>(<span class="kw">as.character</span>(clonal_architecture_subset[clonal_architecture_subset<span class="op">$</span>Genotype<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>),<span class="st">&quot;Mutant&quot;</span>]))</span>
<span id="cb57-876"><a href="functions.html#cb57-876"></a>    </span>
<span id="cb57-877"><a href="functions.html#cb57-877"></a>    <span class="cf">if</span>(shrink<span class="op">==</span><span class="ot">TRUE</span>){</span>
<span id="cb57-878"><a href="functions.html#cb57-878"></a>      clonal_architecture_subset &lt;-clonal_architecture_subset<span class="op">%&gt;%</span><span class="kw">filter</span>(Mutant<span class="op">%in%</span>genes_to_display)</span>
<span id="cb57-879"><a href="functions.html#cb57-879"></a>    }</span>
<span id="cb57-880"><a href="functions.html#cb57-880"></a>    clonal_architecture_subset<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_architecture_subset<span class="op">$</span>Clone, <span class="dt">levels=</span><span class="kw">levels</span>(clonal_abundance_subset<span class="op">$</span>Clone))</span>
<span id="cb57-881"><a href="functions.html#cb57-881"></a>    melted_protein_mat_subset&lt;-melted_protein_mat<span class="op">%&gt;%</span><span class="kw">filter</span>(Clone<span class="op">%in%</span><span class="kw">as.character</span>(clonal_architecture_subset<span class="op">$</span>Clone))</span>
<span id="cb57-882"><a href="functions.html#cb57-882"></a>    melted_protein_mat_subset<span class="op">$</span>Clone &lt;-<span class="kw">factor</span>(melted_protein_mat_subset<span class="op">$</span>Clone, <span class="dt">levels=</span><span class="kw">levels</span>(clonal_abundance_subset<span class="op">$</span>Clone))</span>
<span id="cb57-883"><a href="functions.html#cb57-883"></a>    gg_protein_heatmap&lt;-<span class="kw">ggplot</span>(melted_protein_mat_subset, <span class="kw">aes</span>(<span class="dt">y=</span>variable, <span class="dt">x=</span>(Clone))) <span class="op">+</span><span class="st"> </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> value),<span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-884"><a href="functions.html#cb57-884"></a><span class="st">      </span><span class="kw">scale_fill_distiller</span>(<span class="dt">palette =</span> <span class="st">&quot;PRGn&quot;</span>)<span class="op">+</span></span>
<span id="cb57-885"><a href="functions.html#cb57-885"></a><span class="st">      </span><span class="kw">theme_minimal</span>(<span class="dt">base_size=</span><span class="dv">6</span>) <span class="op">+</span></span>
<span id="cb57-886"><a href="functions.html#cb57-886"></a><span class="st">      </span><span class="kw">theme</span>( <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>(), </span>
<span id="cb57-887"><a href="functions.html#cb57-887"></a>             <span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>,<span class="dt">legend.direction =</span> <span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb57-888"><a href="functions.html#cb57-888"></a>             <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb57-889"><a href="functions.html#cb57-889"></a>             <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-890"><a href="functions.html#cb57-890"></a>    </span>
<span id="cb57-891"><a href="functions.html#cb57-891"></a>     gg_heatmap &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> clonal_architecture_subset, <span class="kw">aes</span>(<span class="dt">x =</span> Clone, <span class="dt">y =</span> <span class="kw">factor</span>(Mutant,<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">levels</span>(<span class="kw">factor</span>(Mutant)))), <span class="dt">fill =</span> Genotype)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-892"><a href="functions.html#cb57-892"></a><span class="st">      </span><span class="kw">geom_tile</span>() <span class="op">+</span><span class="co"># scale_y_discrete(limits = rev(levels(Mutant)))+</span></span>
<span id="cb57-893"><a href="functions.html#cb57-893"></a><span class="st">      </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb57-894"><a href="functions.html#cb57-894"></a>                                 <span class="st">&quot;Heterozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb57-895"><a href="functions.html#cb57-895"></a>                                 <span class="st">&quot;Homozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb57-896"><a href="functions.html#cb57-896"></a>                                 <span class="st">&quot;Unknown&quot;</span>=<span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="op">+</span></span>
<span id="cb57-897"><a href="functions.html#cb57-897"></a><span class="st">      </span><span class="kw">theme_classic</span>(<span class="dt">base_size=</span><span class="dv">6</span>) <span class="op">+</span></span>
<span id="cb57-898"><a href="functions.html#cb57-898"></a><span class="st">      </span><span class="kw">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="op">+</span></span>
<span id="cb57-899"><a href="functions.html#cb57-899"></a><span class="st">      </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;right&quot;</span>, <span class="dt">legend.direction =</span> <span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb57-900"><a href="functions.html#cb57-900"></a>            <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(), </span>
<span id="cb57-901"><a href="functions.html#cb57-901"></a>            <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-902"><a href="functions.html#cb57-902"></a>            <span class="dt">axis.title.x=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-903"><a href="functions.html#cb57-903"></a>            <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb57-904"><a href="functions.html#cb57-904"></a>            <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-905"><a href="functions.html#cb57-905"></a>    </span>
<span id="cb57-906"><a href="functions.html#cb57-906"></a>    clone_colors &lt;-<span class="st"> </span><span class="kw">alphabet</span>()[<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(<span class="kw">unique</span>(clonal_abundance_subset<span class="op">$</span>Clone))]</span>
<span id="cb57-907"><a href="functions.html#cb57-907"></a>    <span class="kw">names</span>(clone_colors) &lt;-<span class="kw">levels</span>(clonal_abundance_subset<span class="op">$</span>Clone)</span>
<span id="cb57-908"><a href="functions.html#cb57-908"></a>    <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb57-909"><a href="functions.html#cb57-909"></a>    gg_clonal_barplot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(clonal_abundance_subset), <span class="kw">aes</span>(<span class="dt">x =</span> Clone, <span class="dt">y =</span> Count)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-910"><a href="functions.html#cb57-910"></a><span class="st">      </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="kw">aes</span>(<span class="dt">fill =</span> Clone)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_gray</span>() <span class="op">+</span></span>
<span id="cb57-911"><a href="functions.html#cb57-911"></a><span class="st">      </span><span class="kw">theme_classic</span>(<span class="dt">base_size=</span><span class="dv">6</span>)<span class="op">+</span></span>
<span id="cb57-912"><a href="functions.html#cb57-912"></a><span class="st">      </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="kw">max</span>(clonal_abundance_subset<span class="op">$</span>Count)<span class="op">*</span><span class="fl">1.3</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-913"><a href="functions.html#cb57-913"></a><span class="st">      </span><span class="kw">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="op">+</span></span>
<span id="cb57-914"><a href="functions.html#cb57-914"></a><span class="st">      </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label=</span>Count), <span class="dt">position=</span><span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="fl">0.9</span>), <span class="dt">vjust=</span><span class="op">-</span><span class="fl">0.25</span>,<span class="dt">size=</span><span class="dv">1</span>)<span class="op">+</span></span>
<span id="cb57-915"><a href="functions.html#cb57-915"></a><span class="st">      </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span>clone_colors)<span class="op">+</span></span>
<span id="cb57-916"><a href="functions.html#cb57-916"></a><span class="st">      </span><span class="kw">theme</span>(<span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(),  <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-917"><a href="functions.html#cb57-917"></a>            <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb57-918"><a href="functions.html#cb57-918"></a>            <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-919"><a href="functions.html#cb57-919"></a>    </span>
<span id="cb57-920"><a href="functions.html#cb57-920"></a>    grob.title &lt;-<span class="st"> </span><span class="kw">textGrob</span>(<span class="kw">paste</span>(sample,<span class="st">&quot;-&quot;</span>), <span class="dt">hjust=</span> <span class="fl">0.5</span>, <span class="dt">vjust =</span> <span class="fl">0.5</span>, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">12</span>))</span>
<span id="cb57-921"><a href="functions.html#cb57-921"></a>    final_plot&lt;-<span class="kw">plot_grid</span>(gg_clonal_barplot,<span class="kw">addSmallLegend</span>(gg_heatmap),<span class="kw">addSmallLegend</span>(gg_protein_heatmap),<span class="dt">ncol=</span><span class="dv">1</span>,<span class="dt">align=</span><span class="st">&quot;hv&quot;</span>,<span class="dt">axis=</span><span class="st">&quot;lrtb&quot;</span>,<span class="dt">rel_heights =</span> <span class="kw">c</span>(<span class="dv">1</span>,(<span class="kw">length</span>(genes_to_display)<span class="op">*</span><span class="fl">0.15</span>),<span class="dv">1</span>))</span>
<span id="cb57-922"><a href="functions.html#cb57-922"></a>    </span>
<span id="cb57-923"><a href="functions.html#cb57-923"></a>    <span class="kw">save_plot</span>(<span class="kw">paste</span>(output_folder,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),final_plot, <span class="dt">ncol=</span><span class="dv">1</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb57-924"><a href="functions.html#cb57-924"></a>  }</span>
<span id="cb57-925"><a href="functions.html#cb57-925"></a></span>
<span id="cb57-926"><a href="functions.html#cb57-926"></a>addSmallLegend &lt;-<span class="st"> </span><span class="cf">function</span>(myPlot, <span class="dt">pointSize =</span> <span class="dv">3</span>, <span class="dt">textSize =</span> <span class="dv">8</span>, <span class="dt">spaceLegend =</span> <span class="fl">0.5</span>) {</span>
<span id="cb57-927"><a href="functions.html#cb57-927"></a>  myPlot <span class="op">+</span></span>
<span id="cb57-928"><a href="functions.html#cb57-928"></a><span class="st">    </span><span class="kw">guides</span>(<span class="dt">shape =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">size =</span> pointSize)),</span>
<span id="cb57-929"><a href="functions.html#cb57-929"></a>           <span class="dt">color =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">size =</span> pointSize))) <span class="op">+</span></span>
<span id="cb57-930"><a href="functions.html#cb57-930"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> textSize), </span>
<span id="cb57-931"><a href="functions.html#cb57-931"></a>          <span class="dt">legend.text  =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> textSize),</span>
<span id="cb57-932"><a href="functions.html#cb57-932"></a>          <span class="dt">legend.key.size =</span> <span class="kw">unit</span>(spaceLegend, <span class="st">&quot;lines&quot;</span>))</span>
<span id="cb57-933"><a href="functions.html#cb57-933"></a>}</span>
<span id="cb57-934"><a href="functions.html#cb57-934"></a></span>
<span id="cb57-935"><a href="functions.html#cb57-935"></a></span>
<span id="cb57-936"><a href="functions.html#cb57-936"></a>create_reward_matrix_deprecated&lt;-<span class="cf">function</span>(Known_mat,weights){</span>
<span id="cb57-937"><a href="functions.html#cb57-937"></a>  <span class="kw">set.seed</span>(<span class="dv">68864</span>)</span>
<span id="cb57-938"><a href="functions.html#cb57-938"></a>  <span class="kw">names</span>(weights) &lt;-<span class="st"> </span><span class="kw">apply</span>(Known_mat,<span class="dv">2</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-939"><a href="functions.html#cb57-939"></a>  num_type &lt;-<span class="st"> </span><span class="dv">2</span></span>
<span id="cb57-940"><a href="functions.html#cb57-940"></a>  num_mutations &lt;-<span class="st"> </span><span class="kw">nrow</span>(Known_mat); </span>
<span id="cb57-941"><a href="functions.html#cb57-941"></a>  num_clones &lt;-<span class="st"> </span><span class="kw">ncol</span>(Known_mat)</span>
<span id="cb57-942"><a href="functions.html#cb57-942"></a>  num_states &lt;-<span class="st"> </span>num_type<span class="op">^</span>num_mutations</span>
<span id="cb57-943"><a href="functions.html#cb57-943"></a>  </span>
<span id="cb57-944"><a href="functions.html#cb57-944"></a>  states&lt;-<span class="kw">data.frame</span>(<span class="kw">expand.grid</span>(<span class="kw">rep</span>(<span class="kw">list</span>(<span class="dv">0</span><span class="op">:</span>num_type), num_mutations)))</span>
<span id="cb57-945"><a href="functions.html#cb57-945"></a>  state_interactions&lt;-<span class="kw">expand.grid</span>(<span class="kw">apply</span>(states[,<span class="dv">1</span><span class="op">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)}),</span>
<span id="cb57-946"><a href="functions.html#cb57-946"></a>                                  <span class="kw">apply</span>(states[,<span class="dv">1</span><span class="op">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)}))</span>
<span id="cb57-947"><a href="functions.html#cb57-947"></a>  </span>
<span id="cb57-948"><a href="functions.html#cb57-948"></a>  states<span class="op">$</span>Reward_states&lt;-<span class="kw">ifelse</span>(<span class="kw">apply</span>(states,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-949"><a href="functions.html#cb57-949"></a>    <span class="kw">any</span>(<span class="kw">apply</span>(Known_mat,<span class="dv">2</span>,<span class="cf">function</span>(y){ <span class="kw">all</span>(x<span class="op">==</span><span class="kw">t</span>(y))}))</span>
<span id="cb57-950"><a href="functions.html#cb57-950"></a>  }),<span class="dv">2</span>,<span class="ot">NA</span>)</span>
<span id="cb57-951"><a href="functions.html#cb57-951"></a>  states<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">apply</span>(states[,<span class="dv">1</span><span class="op">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-952"><a href="functions.html#cb57-952"></a>  </span>
<span id="cb57-953"><a href="functions.html#cb57-953"></a>  state_interactions<span class="op">$</span>possible&lt;-<span class="kw">ifelse</span>(<span class="kw">apply</span>(state_interactions,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-954"><a href="functions.html#cb57-954"></a>    A&lt;-<span class="kw">as.numeric</span>(<span class="kw">do.call</span>(cbind,<span class="kw">strsplit</span>(<span class="kw">as.character</span>(x[<span class="dv">1</span>]),<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb57-955"><a href="functions.html#cb57-955"></a>    B&lt;-<span class="kw">as.numeric</span>(<span class="kw">do.call</span>(cbind,<span class="kw">strsplit</span>(<span class="kw">as.character</span>(x[<span class="dv">2</span>]),<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb57-956"><a href="functions.html#cb57-956"></a>    <span class="kw">sum</span>(<span class="kw">abs</span>(A<span class="op">-</span>B))<span class="op">&lt;=</span><span class="dv">1</span></span>
<span id="cb57-957"><a href="functions.html#cb57-957"></a>  }),<span class="dv">2</span>,<span class="ot">NA</span>)</span>
<span id="cb57-958"><a href="functions.html#cb57-958"></a>  </span>
<span id="cb57-959"><a href="functions.html#cb57-959"></a>  dat&lt;-<span class="kw">acast</span>(Var1<span class="op">~</span>Var2,<span class="dt">value.var=</span><span class="st">&quot;possible&quot;</span>,<span class="dt">data=</span><span class="kw">data.frame</span>(state_interactions,</span>
<span id="cb57-960"><a href="functions.html#cb57-960"></a>                                                            <span class="st">&quot;value&quot;</span>=<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb57-961"><a href="functions.html#cb57-961"></a>  <span class="kw">diag</span>(dat)&lt;-<span class="dv">0</span></span>
<span id="cb57-962"><a href="functions.html#cb57-962"></a>  <span class="kw">lowerTriangle</span>(dat)&lt;-<span class="ot">NA</span></span>
<span id="cb57-963"><a href="functions.html#cb57-963"></a>  </span>
<span id="cb57-964"><a href="functions.html#cb57-964"></a>  test_dat&lt;-<span class="kw">do.call</span>(cbind,<span class="kw">lapply</span>(<span class="kw">colnames</span>(dat),<span class="cf">function</span>(Clone){</span>
<span id="cb57-965"><a href="functions.html#cb57-965"></a>    <span class="cf">if</span>(Clone<span class="op">%in%</span><span class="kw">names</span>(weights)){</span>
<span id="cb57-966"><a href="functions.html#cb57-966"></a>      output&lt;-<span class="kw">ifelse</span>(dat[,Clone]<span class="op">==</span><span class="dv">2</span>,weights[Clone],dat[,Clone])</span>
<span id="cb57-967"><a href="functions.html#cb57-967"></a>    } <span class="cf">else</span>{</span>
<span id="cb57-968"><a href="functions.html#cb57-968"></a>      output&lt;-dat[,Clone]</span>
<span id="cb57-969"><a href="functions.html#cb57-969"></a>    }</span>
<span id="cb57-970"><a href="functions.html#cb57-970"></a>    <span class="kw">return</span>(output)</span>
<span id="cb57-971"><a href="functions.html#cb57-971"></a>  }))</span>
<span id="cb57-972"><a href="functions.html#cb57-972"></a>  <span class="kw">colnames</span>(test_dat) &lt;-<span class="kw">rownames</span>(test_dat)</span>
<span id="cb57-973"><a href="functions.html#cb57-973"></a>  graph&lt;-<span class="kw">graph.adjacency</span>(test_dat,<span class="dt">mode=</span><span class="st">&quot;directed&quot;</span>,<span class="dt">weighted=</span><span class="ot">TRUE</span>)</span>
<span id="cb57-974"><a href="functions.html#cb57-974"></a>  graph_mat &lt;-<span class="st"> </span><span class="kw">get.data.frame</span>(graph)<span class="op">%&gt;%</span><span class="st"> </span><span class="kw">drop_na</span>()</span>
<span id="cb57-975"><a href="functions.html#cb57-975"></a>  </span>
<span id="cb57-976"><a href="functions.html#cb57-976"></a>  subgraphs&lt;-<span class="kw">make_ego_graph</span>(<span class="kw">graph_from_data_frame</span>(graph_mat,<span class="dt">directed=</span><span class="ot">TRUE</span>), <span class="dt">order=</span><span class="dv">1</span>,<span class="dt">nodes=</span><span class="kw">names</span>(weights), <span class="dt">mode=</span><span class="st">&quot;all&quot;</span>)</span>
<span id="cb57-977"><a href="functions.html#cb57-977"></a>  subgraph_bind&lt;-<span class="kw">do.call</span>(rbind,<span class="kw">lapply</span>(subgraphs,get.data.frame)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>(to,from,weight, <span class="dt">.keep_all =</span> <span class="ot">TRUE</span>)</span>
<span id="cb57-978"><a href="functions.html#cb57-978"></a>  subgraph_subset&lt;-subgraph_bind<span class="op">%&gt;%</span><span class="kw">filter</span>(<span class="op">!</span>to<span class="op">%in%</span><span class="kw">setdiff</span>(<span class="kw">setdiff</span>(subgraph_bind<span class="op">$</span>to,subgraph_bind<span class="op">$</span>from),<span class="kw">names</span>(weights)))</span>
<span id="cb57-979"><a href="functions.html#cb57-979"></a>  <span class="kw">return</span>(subgraph_subset)</span>
<span id="cb57-980"><a href="functions.html#cb57-980"></a>}</span>
<span id="cb57-981"><a href="functions.html#cb57-981"></a></span>
<span id="cb57-982"><a href="functions.html#cb57-982"></a></span>
<span id="cb57-983"><a href="functions.html#cb57-983"></a>create_reward_matrix&lt;-<span class="cf">function</span>(Known_mat,weights){</span>
<span id="cb57-984"><a href="functions.html#cb57-984"></a>  </span>
<span id="cb57-985"><a href="functions.html#cb57-985"></a>  <span class="kw">set.seed</span>(<span class="dv">68864</span>)</span>
<span id="cb57-986"><a href="functions.html#cb57-986"></a>  <span class="kw">names</span>(weights) &lt;-<span class="st"> </span><span class="kw">apply</span>(Known_mat,<span class="dv">2</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)})</span>
<span id="cb57-987"><a href="functions.html#cb57-987"></a>  num_type &lt;-<span class="st"> </span><span class="dv">2</span></span>
<span id="cb57-988"><a href="functions.html#cb57-988"></a>  num_mutations &lt;-<span class="st"> </span><span class="kw">nrow</span>(Known_mat); </span>
<span id="cb57-989"><a href="functions.html#cb57-989"></a>  mutant_names&lt;-<span class="kw">rownames</span>(Known_mat)</span>
<span id="cb57-990"><a href="functions.html#cb57-990"></a>  num_clones &lt;-<span class="st"> </span><span class="kw">ncol</span>(Known_mat)</span>
<span id="cb57-991"><a href="functions.html#cb57-991"></a>  num_states &lt;-<span class="st"> </span>num_type<span class="op">^</span>num_mutations</span>
<span id="cb57-992"><a href="functions.html#cb57-992"></a>  </span>
<span id="cb57-993"><a href="functions.html#cb57-993"></a>  possible_mut_list&lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">apply</span>(Known_mat,<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">list</span>(<span class="dv">0</span><span class="op">:</span><span class="kw">max</span>(<span class="kw">unique</span>(x))) }),<span class="dt">recursive =</span> <span class="ot">FALSE</span>)</span>
<span id="cb57-994"><a href="functions.html#cb57-994"></a>  </span>
<span id="cb57-995"><a href="functions.html#cb57-995"></a>  states&lt;-<span class="kw">data.frame</span>(<span class="kw">expand.grid</span>(possible_mut_list))</span>
<span id="cb57-996"><a href="functions.html#cb57-996"></a>  state_interactions&lt;-<span class="kw">data.frame</span>(<span class="kw">expand.grid</span>(<span class="kw">apply</span>(states[,<span class="dv">1</span><span class="op">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)}),</span>
<span id="cb57-997"><a href="functions.html#cb57-997"></a>                                             <span class="kw">apply</span>(states[,<span class="dv">1</span><span class="op">:</span>num_mutations],<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="kw">paste</span>(x,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)})))</span>
<span id="cb57-998"><a href="functions.html#cb57-998"></a>  </span>
<span id="cb57-999"><a href="functions.html#cb57-999"></a>  state_interactions<span class="op">$</span>possible&lt;-<span class="kw">ifelse</span>(<span class="kw">apply</span>(state_interactions,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-1000"><a href="functions.html#cb57-1000"></a>    A&lt;-<span class="kw">as.numeric</span>(<span class="kw">do.call</span>(cbind,<span class="kw">strsplit</span>(<span class="kw">as.character</span>(x[<span class="dv">1</span>]),<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb57-1001"><a href="functions.html#cb57-1001"></a>    B&lt;-<span class="kw">as.numeric</span>(<span class="kw">do.call</span>(cbind,<span class="kw">strsplit</span>(<span class="kw">as.character</span>(x[<span class="dv">2</span>]),<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb57-1002"><a href="functions.html#cb57-1002"></a>    <span class="kw">sum</span>(<span class="kw">abs</span>(A<span class="op">-</span>B))<span class="op">&lt;=</span><span class="dv">1</span></span>
<span id="cb57-1003"><a href="functions.html#cb57-1003"></a>  }),<span class="dv">0</span>,<span class="ot">NA</span>)</span>
<span id="cb57-1004"><a href="functions.html#cb57-1004"></a>  </span>
<span id="cb57-1005"><a href="functions.html#cb57-1005"></a>  state_interactions<span class="op">$</span>action&lt;-<span class="kw">apply</span>(state_interactions,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-1006"><a href="functions.html#cb57-1006"></a>    A&lt;-<span class="kw">as.numeric</span>(<span class="kw">do.call</span>(cbind,<span class="kw">strsplit</span>(<span class="kw">as.character</span>(x[<span class="dv">1</span>]),<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb57-1007"><a href="functions.html#cb57-1007"></a>    B&lt;-<span class="kw">as.numeric</span>(<span class="kw">do.call</span>(cbind,<span class="kw">strsplit</span>(<span class="kw">as.character</span>(x[<span class="dv">2</span>]),<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb57-1008"><a href="functions.html#cb57-1008"></a>    <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(x[<span class="st">&quot;possible&quot;</span>])){</span>
<span id="cb57-1009"><a href="functions.html#cb57-1009"></a>      <span class="cf">if</span>(<span class="kw">sum</span>(<span class="kw">abs</span>(B<span class="op">-</span>A))<span class="op">==</span><span class="dv">0</span>){</span>
<span id="cb57-1010"><a href="functions.html#cb57-1010"></a>        <span class="kw">return</span>(<span class="st">&quot;stay&quot;</span>)</span>
<span id="cb57-1011"><a href="functions.html#cb57-1011"></a>      } <span class="cf">else</span>{</span>
<span id="cb57-1012"><a href="functions.html#cb57-1012"></a>        <span class="kw">return</span>(mutant_names[<span class="kw">which</span>((B<span class="op">-</span>A)<span class="op">==</span><span class="dv">1</span>)])</span>
<span id="cb57-1013"><a href="functions.html#cb57-1013"></a>      }</span>
<span id="cb57-1014"><a href="functions.html#cb57-1014"></a>    }</span>
<span id="cb57-1015"><a href="functions.html#cb57-1015"></a>  })</span>
<span id="cb57-1016"><a href="functions.html#cb57-1016"></a>  </span>
<span id="cb57-1017"><a href="functions.html#cb57-1017"></a>  dat&lt;-<span class="kw">setNames</span>(state_interactions<span class="op">%&gt;%</span><span class="kw">filter</span>(action<span class="op">%in%</span><span class="kw">c</span>(mutant_names,<span class="st">&quot;stay&quot;</span>)),</span>
<span id="cb57-1018"><a href="functions.html#cb57-1018"></a>                <span class="kw">c</span>(<span class="st">&quot;State&quot;</span>,<span class="st">&quot;NextState&quot;</span>,<span class="st">&quot;Reward&quot;</span>,<span class="st">&quot;Action&quot;</span>))[,<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">3</span>)]</span>
<span id="cb57-1019"><a href="functions.html#cb57-1019"></a>  </span>
<span id="cb57-1020"><a href="functions.html#cb57-1020"></a>  dat<span class="op">$</span>Reward &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">apply</span>(dat,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-1021"><a href="functions.html#cb57-1021"></a>    <span class="kw">ifelse</span>(x<span class="op">$</span>NextState<span class="op">%in%</span><span class="kw">names</span>(weights),weights[x<span class="op">$</span>NextState],x<span class="op">$</span>Reward)</span>
<span id="cb57-1022"><a href="functions.html#cb57-1022"></a>  }))</span>
<span id="cb57-1023"><a href="functions.html#cb57-1023"></a>  dat<span class="op">$</span>Reward &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">apply</span>(dat,<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb57-1024"><a href="functions.html#cb57-1024"></a>    <span class="kw">ifelse</span>(x<span class="op">$</span>Action<span class="op">%in%</span><span class="st">&quot;stay&quot;</span>,<span class="dv">0</span>,x<span class="op">$</span>Reward)</span>
<span id="cb57-1025"><a href="functions.html#cb57-1025"></a>  }))</span>
<span id="cb57-1026"><a href="functions.html#cb57-1026"></a>  dat<span class="op">$</span>State &lt;-<span class="st"> </span><span class="kw">as.character</span>(dat<span class="op">$</span>State)</span>
<span id="cb57-1027"><a href="functions.html#cb57-1027"></a>  dat<span class="op">$</span>NextState &lt;-<span class="st"> </span><span class="kw">as.character</span>(dat<span class="op">$</span>NextState)</span>
<span id="cb57-1028"><a href="functions.html#cb57-1028"></a>  dat<span class="op">$</span>Action &lt;-<span class="st"> </span><span class="kw">as.character</span>(dat<span class="op">$</span>Action)</span>
<span id="cb57-1029"><a href="functions.html#cb57-1029"></a>  </span>
<span id="cb57-1030"><a href="functions.html#cb57-1030"></a>  control &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">alpha =</span> <span class="fl">0.8</span>, <span class="dt">gamma =</span> <span class="fl">0.9</span>)</span>
<span id="cb57-1031"><a href="functions.html#cb57-1031"></a>  model &lt;-<span class="st"> </span><span class="kw">ReinforcementLearning</span>(<span class="dt">data =</span> dat, <span class="dt">s =</span> <span class="st">&quot;State&quot;</span>, <span class="dt">a =</span> <span class="st">&quot;Action&quot;</span>, <span class="dt">r =</span> <span class="st">&quot;Reward&quot;</span>,  <span class="dt">s_new =</span> <span class="st">&quot;NextState&quot;</span>,  <span class="dt">iter =</span>  <span class="dv">1</span>,<span class="dt">control=</span>control)</span>
<span id="cb57-1032"><a href="functions.html#cb57-1032"></a>  x&lt;-<span class="st"> </span>model<span class="op">$</span>Q</span>
<span id="cb57-1033"><a href="functions.html#cb57-1033"></a>  <span class="kw">rownames</span>(x) &lt;-<span class="st"> </span><span class="kw">substring</span>(<span class="kw">rownames</span>(x),<span class="dv">2</span>)</span>
<span id="cb57-1034"><a href="functions.html#cb57-1034"></a>  Q_mat &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">melt</span>(x),<span class="kw">c</span>(<span class="st">&quot;State&quot;</span>,<span class="st">&quot;Action&quot;</span>,<span class="st">&quot;Q&quot;</span>))</span>
<span id="cb57-1035"><a href="functions.html#cb57-1035"></a>  set&lt;-<span class="kw">inner_join</span>(dat,Q_mat,<span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;State&quot;</span>,<span class="st">&quot;Action&quot;</span>))</span>
<span id="cb57-1036"><a href="functions.html#cb57-1036"></a>  set<span class="op">$</span>Valid &lt;-<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb57-1037"><a href="functions.html#cb57-1037"></a>  <span class="kw">return</span>(set)</span>
<span id="cb57-1038"><a href="functions.html#cb57-1038"></a>  }</span>
<span id="cb57-1039"><a href="functions.html#cb57-1039"></a></span>
<span id="cb57-1040"><a href="functions.html#cb57-1040"></a></span>
<span id="cb57-1041"><a href="functions.html#cb57-1041"></a>plot_clonal_heatmap_and_barplot_with_SD &lt;-<span class="cf">function</span>(sample,output_folder,clonal_abundance,clonal_architecture,clone_cell_count,shrink)</span>
<span id="cb57-1042"><a href="functions.html#cb57-1042"></a>{</span>
<span id="cb57-1043"><a href="functions.html#cb57-1043"></a>  clonal_abundance_subset &lt;-<span class="kw">data.frame</span>( clonal_abundance[[sample]])<span class="co">#%&gt;%filter(Count&gt;=5)</span></span>
<span id="cb57-1044"><a href="functions.html#cb57-1044"></a>  clones_to_use &lt;-<span class="st"> </span><span class="kw">intersect</span>(<span class="kw">as.character</span>(clonal_abundance_subset<span class="op">$</span>Clone),<span class="kw">as.character</span>(clonal_architecture[[sample]]<span class="op">$</span>Clone))</span>
<span id="cb57-1045"><a href="functions.html#cb57-1045"></a>  clonal_architecture_subset &lt;-<span class="st"> </span><span class="kw">data.frame</span>(clonal_architecture[[sample]])<span class="op">%&gt;%</span></span>
<span id="cb57-1046"><a href="functions.html#cb57-1046"></a><span class="st">    </span><span class="kw">filter</span>(<span class="kw">data.frame</span>(clonal_architecture[[sample]])<span class="op">$</span>Clone<span class="op">%in%</span>clones_to_use)</span>
<span id="cb57-1047"><a href="functions.html#cb57-1047"></a>  clonal_abundance_subset &lt;-<span class="st"> </span><span class="kw">data.frame</span>(clonal_abundance_subset)<span class="op">%&gt;%</span></span>
<span id="cb57-1048"><a href="functions.html#cb57-1048"></a><span class="st">    </span><span class="kw">filter</span>(Clone<span class="op">%in%</span>clones_to_use)</span>
<span id="cb57-1049"><a href="functions.html#cb57-1049"></a>  genes_to_display &lt;-<span class="kw">unique</span>(<span class="kw">as.character</span>(clonal_architecture_subset[clonal_architecture_subset<span class="op">$</span>Genotype<span class="op">%in%</span><span class="kw">c</span>(<span class="st">&quot;Heterozygous&quot;</span>,<span class="st">&quot;Homozygous&quot;</span>),<span class="st">&quot;Mutant&quot;</span>]))</span>
<span id="cb57-1050"><a href="functions.html#cb57-1050"></a>  </span>
<span id="cb57-1051"><a href="functions.html#cb57-1051"></a>  <span class="cf">if</span>(shrink<span class="op">==</span><span class="ot">TRUE</span>){</span>
<span id="cb57-1052"><a href="functions.html#cb57-1052"></a>    clonal_architecture_subset &lt;-clonal_architecture_subset<span class="op">%&gt;%</span><span class="kw">filter</span>(Mutant<span class="op">%in%</span>genes_to_display)</span>
<span id="cb57-1053"><a href="functions.html#cb57-1053"></a>  }</span>
<span id="cb57-1054"><a href="functions.html#cb57-1054"></a>  clonal_architecture_subset<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_architecture_subset<span class="op">$</span>Clone, <span class="dt">levels=</span><span class="kw">rev</span>(clonal_abundance_subset<span class="op">$</span>Clone))</span>
<span id="cb57-1055"><a href="functions.html#cb57-1055"></a>  clonal_abundance_subset<span class="op">$</span>Clone &lt;-<span class="st"> </span><span class="kw">factor</span>(clonal_abundance_subset<span class="op">$</span>Clone, <span class="dt">levels=</span><span class="kw">levels</span>(clonal_architecture_subset<span class="op">$</span>Clone))</span>
<span id="cb57-1056"><a href="functions.html#cb57-1056"></a>  gg_heatmap &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> clonal_architecture_subset, <span class="kw">aes</span>(<span class="dt">x =</span> Clone, <span class="dt">y =</span> <span class="kw">factor</span>(Mutant,<span class="dt">levels=</span><span class="kw">rev</span>(<span class="kw">levels</span>(<span class="kw">factor</span>(Mutant)))), <span class="dt">fill =</span> Genotype)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-1057"><a href="functions.html#cb57-1057"></a><span class="st">    </span><span class="kw">geom_tile</span>() <span class="op">+</span><span class="co"># scale_y_discrete(limits = rev(levels(Mutant)))+</span></span>
<span id="cb57-1058"><a href="functions.html#cb57-1058"></a><span class="st">    </span></span>
<span id="cb57-1059"><a href="functions.html#cb57-1059"></a><span class="st">    </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;WT&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">1</span>],</span>
<span id="cb57-1060"><a href="functions.html#cb57-1060"></a>                               <span class="st">&quot;Heterozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">3</span>],</span>
<span id="cb57-1061"><a href="functions.html#cb57-1061"></a>                               <span class="st">&quot;Homozygous&quot;</span>=<span class="kw">brewer.pal</span>(<span class="dv">7</span>,<span class="st">&quot;Reds&quot;</span>)[<span class="dv">6</span>],</span>
<span id="cb57-1062"><a href="functions.html#cb57-1062"></a>                               <span class="st">&quot;Unknown&quot;</span>=<span class="st">&quot;grey50&quot;</span>),<span class="st">&quot;Genotype&quot;</span>)  <span class="op">+</span></span>
<span id="cb57-1063"><a href="functions.html#cb57-1063"></a><span class="st">    </span><span class="kw">theme_classic</span>(<span class="dt">base_size=</span><span class="dv">6</span>) <span class="op">+</span></span>
<span id="cb57-1064"><a href="functions.html#cb57-1064"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Mutation&quot;</span>)<span class="op">+</span></span>
<span id="cb57-1065"><a href="functions.html#cb57-1065"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, <span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb57-1066"><a href="functions.html#cb57-1066"></a>          <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(), </span>
<span id="cb57-1067"><a href="functions.html#cb57-1067"></a>          <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-1068"><a href="functions.html#cb57-1068"></a>          <span class="dt">axis.title.x=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-1069"><a href="functions.html#cb57-1069"></a>          <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb57-1070"><a href="functions.html#cb57-1070"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-1071"><a href="functions.html#cb57-1071"></a>  </span>
<span id="cb57-1072"><a href="functions.html#cb57-1072"></a>  <span class="co"># Generate clonal abundance barplot</span></span>
<span id="cb57-1073"><a href="functions.html#cb57-1073"></a>  gg_clonal_barplot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">data.frame</span>(clonal_abundance_subset), <span class="kw">aes</span>(<span class="dt">x =</span> Clone, <span class="dt">y =</span> Count)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-1074"><a href="functions.html#cb57-1074"></a><span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="kw">aes</span>(<span class="dt">fill =</span> Count)) <span class="op">+</span><span class="st"> </span><span class="kw">theme_gray</span>() <span class="op">+</span></span>
<span id="cb57-1075"><a href="functions.html#cb57-1075"></a><span class="st">    </span><span class="kw">theme_classic</span>(<span class="dt">base_size=</span><span class="dv">6</span>)<span class="op">+</span></span>
<span id="cb57-1076"><a href="functions.html#cb57-1076"></a><span class="st">    </span><span class="kw">ylim</span>(<span class="dv">0</span>,<span class="kw">max</span>(clonal_abundance_subset<span class="op">$</span>Count)<span class="op">*</span><span class="fl">1.3</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-1077"><a href="functions.html#cb57-1077"></a><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Cell Count&quot;</span>)<span class="op">+</span></span>
<span id="cb57-1078"><a href="functions.html#cb57-1078"></a><span class="st">    </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> X2.<span class="fl">5.</span>, <span class="dt">ymax =</span> X97.<span class="fl">5.</span>), <span class="dt">width =</span> <span class="fl">0.2</span>)<span class="op">+</span></span>
<span id="cb57-1079"><a href="functions.html#cb57-1079"></a><span class="st">    </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label=</span>Count), <span class="dt">position=</span><span class="kw">position_dodge</span>(<span class="dt">width=</span><span class="fl">0.9</span>), <span class="dt">vjust=</span><span class="op">-</span><span class="fl">0.25</span>,<span class="dt">size=</span><span class="dv">1</span>)<span class="op">+</span></span>
<span id="cb57-1080"><a href="functions.html#cb57-1080"></a><span class="st">    </span><span class="kw">scale_fill_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;Value&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;Reds&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb57-1081"><a href="functions.html#cb57-1081"></a><span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.title.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>(),  <span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</span>
<span id="cb57-1082"><a href="functions.html#cb57-1082"></a>          <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb57-1083"><a href="functions.html#cb57-1083"></a>          <span class="dt">plot.margin=</span><span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="op">-</span><span class="fl">0.2</span>,<span class="dv">1</span>),<span class="st">&quot;cm&quot;</span>))</span>
<span id="cb57-1084"><a href="functions.html#cb57-1084"></a>  </span>
<span id="cb57-1085"><a href="functions.html#cb57-1085"></a>  grob.title &lt;-<span class="st"> </span><span class="kw">textGrob</span>(<span class="kw">paste</span>(sample,<span class="st">&quot;-&quot;</span>), <span class="dt">hjust=</span> <span class="fl">0.5</span>, <span class="dt">vjust =</span> <span class="fl">0.5</span>, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">12</span>))</span>
<span id="cb57-1086"><a href="functions.html#cb57-1086"></a>  final_plot&lt;-<span class="kw">plot_grid</span>(grob.title,gg_clonal_barplot,gg_heatmap,<span class="dt">ncol=</span><span class="dv">1</span>,<span class="dt">align=</span><span class="st">&quot;hv&quot;</span>,<span class="dt">axis=</span><span class="st">&quot;l&quot;</span>,<span class="dt">rel_heights =</span> <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="fl">0.75</span>))</span>
<span id="cb57-1087"><a href="functions.html#cb57-1087"></a>  </span>
<span id="cb57-1088"><a href="functions.html#cb57-1088"></a>  <span class="kw">save_plot</span>(<span class="kw">paste</span>(output_folder,sample,<span class="st">&quot;.pdf&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),final_plot, <span class="dt">ncol=</span><span class="dv">1</span>) <span class="co"># Open a new pdf file</span></span>
<span id="cb57-1089"><a href="functions.html#cb57-1089"></a>}</span>
<span id="cb57-1090"><a href="functions.html#cb57-1090"></a></span>
<span id="cb57-1091"><a href="functions.html#cb57-1091"></a>query_initiating_mutations&lt;-<span class="cf">function</span>(graph_results){</span>
<span id="cb57-1092"><a href="functions.html#cb57-1092"></a>  start_index&lt;-<span class="kw">paste</span>(<span class="kw">rep</span>(<span class="dv">0</span>,<span class="kw">length</span>(<span class="kw">strsplit</span>(graph_results<span class="op">$</span>State[<span class="dv">1</span>],<span class="dt">split=</span><span class="st">&quot;_&quot;</span>)[[<span class="dv">1</span>]])),<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>,<span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>)</span>
<span id="cb57-1093"><a href="functions.html#cb57-1093"></a>  possible_starting_actions&lt;-graph_results<span class="op">%&gt;%</span><span class="kw">filter</span>(State<span class="op">==</span>start_index<span class="op">&amp;</span>Action<span class="op">!=</span><span class="st">&quot;stay&quot;</span>)<span class="op">%&gt;%</span><span class="kw">pull</span>(Action)</span>
<span id="cb57-1094"><a href="functions.html#cb57-1094"></a>  final_results&lt;-<span class="kw">list</span>()</span>
<span id="cb57-1095"><a href="functions.html#cb57-1095"></a>  initating_action_count&lt;-<span class="dv">0</span></span>
<span id="cb57-1096"><a href="functions.html#cb57-1096"></a>  <span class="cf">for</span>(initating_action <span class="cf">in</span> possible_starting_actions){</span>
<span id="cb57-1097"><a href="functions.html#cb57-1097"></a>    <span class="kw">print</span>(initating_action)</span>
<span id="cb57-1098"><a href="functions.html#cb57-1098"></a>    set &lt;-<span class="st"> </span>graph_results</span>
<span id="cb57-1099"><a href="functions.html#cb57-1099"></a>    initating_action_count&lt;-initating_action_count<span class="op">+</span><span class="dv">1</span></span>
<span id="cb57-1100"><a href="functions.html#cb57-1100"></a>    storage_results&lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb57-1101"><a href="functions.html#cb57-1101"></a>    branches&lt;-<span class="dv">0</span></span>
<span id="cb57-1102"><a href="functions.html#cb57-1102"></a>    state_to_kill &lt;-<span class="st"> </span>set<span class="op">%&gt;%</span><span class="kw">filter</span>(State<span class="op">==</span>start_index<span class="op">&amp;</span>Action<span class="op">==</span>initating_action)<span class="op">%&gt;%</span><span class="kw">pull</span>(NextState)</span>
<span id="cb57-1103"><a href="functions.html#cb57-1103"></a>    start_killed &lt;-<span class="st"> </span><span class="kw">sum</span>(set<span class="op">%&gt;%</span><span class="kw">filter</span>(State<span class="op">==</span>state_to_kill)<span class="op">%&gt;%</span><span class="kw">pull</span>(Valid))</span>
<span id="cb57-1104"><a href="functions.html#cb57-1104"></a>    <span class="cf">while</span>(start_killed<span class="op">&gt;</span><span class="dv">0</span>){</span>
<span id="cb57-1105"><a href="functions.html#cb57-1105"></a>      <span class="co">#print(branches)</span></span>
<span id="cb57-1106"><a href="functions.html#cb57-1106"></a>     <span class="co"># print(start_killed)</span></span>
<span id="cb57-1107"><a href="functions.html#cb57-1107"></a>      branches &lt;-<span class="st"> </span>branches <span class="op">+</span><span class="dv">1</span></span>
<span id="cb57-1108"><a href="functions.html#cb57-1108"></a>      number_of_mutations&lt;-<span class="dv">0</span></span>
<span id="cb57-1109"><a href="functions.html#cb57-1109"></a>      state_log&lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb57-1110"><a href="functions.html#cb57-1110"></a>      optimal_reward&lt;-<span class="kw">list</span>()</span>
<span id="cb57-1111"><a href="functions.html#cb57-1111"></a>      action_log&lt;-<span class="kw">list</span>()</span>
<span id="cb57-1112"><a href="functions.html#cb57-1112"></a>      current_state&lt;-<span class="st"> </span>start_index</span>
<span id="cb57-1113"><a href="functions.html#cb57-1113"></a>      indicator&lt;-<span class="ot">TRUE</span></span>
<span id="cb57-1114"><a href="functions.html#cb57-1114"></a>      nextState&lt;-<span class="dv">0</span></span>
<span id="cb57-1115"><a href="functions.html#cb57-1115"></a>      <span class="cf">while</span>(current_state<span class="op">!=</span>nextState)  {</span>
<span id="cb57-1116"><a href="functions.html#cb57-1116"></a>       <span class="co"># print(number_of_mutations)</span></span>
<span id="cb57-1117"><a href="functions.html#cb57-1117"></a>        number_of_mutations &lt;-<span class="st"> </span>number_of_mutations<span class="op">+</span><span class="dv">1</span></span>
<span id="cb57-1118"><a href="functions.html#cb57-1118"></a>        <span class="cf">if</span>(number_of_mutations<span class="op">==</span><span class="dv">1</span>){</span>
<span id="cb57-1119"><a href="functions.html#cb57-1119"></a>          state_log[[number_of_mutations]] &lt;-<span class="st"> </span>start_index</span>
<span id="cb57-1120"><a href="functions.html#cb57-1120"></a>        }</span>
<span id="cb57-1121"><a href="functions.html#cb57-1121"></a>        current_state  &lt;-<span class="st"> </span>state_log[[number_of_mutations]]</span>
<span id="cb57-1122"><a href="functions.html#cb57-1122"></a>        nextState_indicator&lt;-<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb57-1123"><a href="functions.html#cb57-1123"></a>        </span>
<span id="cb57-1124"><a href="functions.html#cb57-1124"></a>        <span class="cf">while</span>(nextState_indicator<span class="op">==</span><span class="ot">FALSE</span>){</span>
<span id="cb57-1125"><a href="functions.html#cb57-1125"></a>          </span>
<span id="cb57-1126"><a href="functions.html#cb57-1126"></a>          <span class="cf">if</span>(number_of_mutations<span class="op">==</span><span class="dv">1</span>){</span>
<span id="cb57-1127"><a href="functions.html#cb57-1127"></a>            max_potential_action_index&lt;-<span class="st">  </span>set<span class="op">%&gt;%</span></span>
<span id="cb57-1128"><a href="functions.html#cb57-1128"></a><span class="st">              </span><span class="kw">filter</span>(State<span class="op">==</span>current_state<span class="op">&amp;</span>Action<span class="op">==</span>initating_action)</span>
<span id="cb57-1129"><a href="functions.html#cb57-1129"></a>          } <span class="cf">else</span> {</span>
<span id="cb57-1130"><a href="functions.html#cb57-1130"></a>            max_potential_action_index &lt;-<span class="st"> </span>set<span class="op">%&gt;%</span></span>
<span id="cb57-1131"><a href="functions.html#cb57-1131"></a><span class="st">              </span><span class="kw">filter</span>(State<span class="op">==</span>current_state<span class="op">&amp;</span>Valid<span class="op">==</span><span class="ot">TRUE</span>)<span class="op">%&gt;%</span></span>
<span id="cb57-1132"><a href="functions.html#cb57-1132"></a><span class="st">              </span><span class="kw">filter</span>(Q<span class="op">==</span><span class="kw">max</span>(Q))<span class="op">%&gt;%</span><span class="kw">sample_n</span>(<span class="dv">1</span>)</span>
<span id="cb57-1133"><a href="functions.html#cb57-1133"></a>          }</span>
<span id="cb57-1134"><a href="functions.html#cb57-1134"></a>          <span class="cf">if</span>(<span class="kw">nrow</span>(max_potential_action_index)<span class="op">==</span><span class="dv">0</span>){</span>
<span id="cb57-1135"><a href="functions.html#cb57-1135"></a>            <span class="cf">break</span></span>
<span id="cb57-1136"><a href="functions.html#cb57-1136"></a>          }</span>
<span id="cb57-1137"><a href="functions.html#cb57-1137"></a>          max_potential_action &lt;-<span class="st"> </span>max_potential_action_index<span class="op">%&gt;%</span><span class="kw">pull</span>(NextState)</span>
<span id="cb57-1138"><a href="functions.html#cb57-1138"></a>          next_valid_action &lt;-<span class="st"> </span><span class="kw">any</span>(set<span class="op">%&gt;%</span><span class="kw">filter</span>(State<span class="op">==</span>max_potential_action<span class="op">&amp;</span>Action<span class="op">!=</span><span class="st">&quot;stay&quot;</span>)<span class="op">%&gt;%</span><span class="kw">pull</span>(Valid))  </span>
<span id="cb57-1139"><a href="functions.html#cb57-1139"></a>          <span class="cf">if</span>(next_valid_action<span class="op">==</span><span class="ot">TRUE</span>){</span>
<span id="cb57-1140"><a href="functions.html#cb57-1140"></a>            nextState &lt;-max_potential_action</span>
<span id="cb57-1141"><a href="functions.html#cb57-1141"></a>            current_action &lt;-<span class="st">  </span>max_potential_action_index<span class="op">%&gt;%</span><span class="kw">pull</span>(Action)</span>
<span id="cb57-1142"><a href="functions.html#cb57-1142"></a>            nextState_indicator<span class="op">==</span><span class="ot">TRUE</span></span>
<span id="cb57-1143"><a href="functions.html#cb57-1143"></a>            <span class="cf">break</span></span>
<span id="cb57-1144"><a href="functions.html#cb57-1144"></a>          } <span class="cf">else</span>{</span>
<span id="cb57-1145"><a href="functions.html#cb57-1145"></a>            set[set<span class="op">$</span>State<span class="op">%in%</span>max_potential_action_index[<span class="st">&quot;State&quot;</span>]<span class="op">&amp;</span></span>
<span id="cb57-1146"><a href="functions.html#cb57-1146"></a><span class="st">                  </span>set<span class="op">$</span>Action<span class="op">%in%</span>max_potential_action_index[<span class="st">&quot;Action&quot;</span>],<span class="st">&quot;Valid&quot;</span>] &lt;-<span class="st"> </span><span class="ot">FALSE</span>  </span>
<span id="cb57-1147"><a href="functions.html#cb57-1147"></a>          }</span>
<span id="cb57-1148"><a href="functions.html#cb57-1148"></a>        }</span>
<span id="cb57-1149"><a href="functions.html#cb57-1149"></a>        <span class="cf">if</span>(<span class="kw">nrow</span>(set<span class="op">%&gt;%</span><span class="kw">filter</span>(State<span class="op">==</span>current_state<span class="op">&amp;</span>Action<span class="op">==</span>current_action))<span class="op">==</span><span class="dv">0</span>){</span>
<span id="cb57-1150"><a href="functions.html#cb57-1150"></a>          optimal_reward[[number_of_mutations]] &lt;-<span class="ot">NA</span></span>
<span id="cb57-1151"><a href="functions.html#cb57-1151"></a>        } <span class="cf">else</span> {</span>
<span id="cb57-1152"><a href="functions.html#cb57-1152"></a>          optimal_reward[[number_of_mutations]] &lt;-<span class="st"> </span>set<span class="op">%&gt;%</span></span>
<span id="cb57-1153"><a href="functions.html#cb57-1153"></a><span class="st">            </span><span class="kw">filter</span>(State<span class="op">==</span>current_state<span class="op">&amp;</span>Action<span class="op">==</span>current_action)<span class="op">%&gt;%</span></span>
<span id="cb57-1154"><a href="functions.html#cb57-1154"></a><span class="st">            </span><span class="kw">pull</span>(Reward) </span>
<span id="cb57-1155"><a href="functions.html#cb57-1155"></a>        }</span>
<span id="cb57-1156"><a href="functions.html#cb57-1156"></a>        state_log[[number_of_mutations<span class="op">+</span><span class="dv">1</span>]]&lt;-<span class="st"> </span>nextState</span>
<span id="cb57-1157"><a href="functions.html#cb57-1157"></a>        action_log[[number_of_mutations]] &lt;-<span class="st"> </span>current_action </span>
<span id="cb57-1158"><a href="functions.html#cb57-1158"></a>        <span class="cf">if</span>(current_action<span class="op">==</span>nextState){</span>
<span id="cb57-1159"><a href="functions.html#cb57-1159"></a>          indicator<span class="op">==</span><span class="ot">FALSE</span></span>
<span id="cb57-1160"><a href="functions.html#cb57-1160"></a>          state_log[[number_of_mutations<span class="op">+</span><span class="dv">1</span>]]&lt;-<span class="ot">NULL</span></span>
<span id="cb57-1161"><a href="functions.html#cb57-1161"></a>          <span class="cf">break</span></span>
<span id="cb57-1162"><a href="functions.html#cb57-1162"></a>        }</span>
<span id="cb57-1163"><a href="functions.html#cb57-1163"></a>      }</span>
<span id="cb57-1164"><a href="functions.html#cb57-1164"></a>      optimal_reward[[number_of_mutations<span class="op">+</span><span class="dv">1</span>]] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb57-1165"><a href="functions.html#cb57-1165"></a>      action_log[[number_of_mutations<span class="op">+</span><span class="dv">1</span>]] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb57-1166"><a href="functions.html#cb57-1166"></a>      storage_results[[branches]] &lt;-<span class="kw">data.frame</span>(<span class="st">&quot;states&quot;</span>=<span class="kw">do.call</span>(rbind,state_log),<span class="co">#[1:(length(state_log)-1)]),</span></span>
<span id="cb57-1167"><a href="functions.html#cb57-1167"></a>                                               <span class="st">&quot;actions&quot;</span>=<span class="kw">do.call</span>(rbind,action_log),</span>
<span id="cb57-1168"><a href="functions.html#cb57-1168"></a>                                               <span class="st">&quot;reward&quot;</span>=<span class="kw">do.call</span>(rbind,optimal_reward),</span>
<span id="cb57-1169"><a href="functions.html#cb57-1169"></a>                                               <span class="st">&quot;nextState&quot;</span>=<span class="kw">do.call</span>(rbind,<span class="kw">c</span>(state_log[<span class="dv">2</span><span class="op">:</span><span class="kw">length</span>(state_log)],<span class="ot">NA</span>)) )</span>
<span id="cb57-1170"><a href="functions.html#cb57-1170"></a>      storage_results[[branches]] &lt;-<span class="st"> </span>storage_results[[branches]]<span class="op">%&gt;%</span></span>
<span id="cb57-1171"><a href="functions.html#cb57-1171"></a><span class="st">        </span><span class="kw">filter</span>(states<span class="op">!=</span>nextState)</span>
<span id="cb57-1172"><a href="functions.html#cb57-1172"></a>      storage_results[[branches]]<span class="op">$</span>cumulative_reward &lt;-<span class="st"> </span><span class="kw">cumsum</span>(storage_results[[branches]]<span class="op">$</span>reward)</span>
<span id="cb57-1173"><a href="functions.html#cb57-1173"></a>      </span>
<span id="cb57-1174"><a href="functions.html#cb57-1174"></a>      <span class="co">#storage_results[[branches]] &lt;-storage_results[[branches]][1:which.max(storage_results[[branches]]$cumulative_reward), ]</span></span>
<span id="cb57-1175"><a href="functions.html#cb57-1175"></a>      set[set<span class="op">$</span>State<span class="op">%in%</span>current_state<span class="op">&amp;</span>set<span class="op">$</span>Action<span class="op">%in%</span>current_action,<span class="st">&quot;Valid&quot;</span>] &lt;-<span class="st"> </span><span class="ot">FALSE</span></span>
<span id="cb57-1176"><a href="functions.html#cb57-1176"></a>      start_killed &lt;-<span class="st"> </span><span class="kw">sum</span>(set<span class="op">%&gt;%</span><span class="kw">filter</span>(State<span class="op">==</span>state_to_kill)<span class="op">%&gt;%</span><span class="kw">pull</span>(Valid))</span>
<span id="cb57-1177"><a href="functions.html#cb57-1177"></a>    }</span>
<span id="cb57-1178"><a href="functions.html#cb57-1178"></a>    final_results[[initating_action_count]]&lt;-storage_results[<span class="op">!</span><span class="kw">duplicated</span>(storage_results)]</span>
<span id="cb57-1179"><a href="functions.html#cb57-1179"></a>  }</span>
<span id="cb57-1180"><a href="functions.html#cb57-1180"></a>  <span class="kw">names</span>(final_results)&lt;-possible_starting_actions</span>
<span id="cb57-1181"><a href="functions.html#cb57-1181"></a>  <span class="kw">return</span>(final_results)</span>
<span id="cb57-1182"><a href="functions.html#cb57-1182"></a>}</span></code></pre></div>

</div>
<!-- </div> -->
            </section>

          </div>
        </div>
      </div>
<a href="AppendixA.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["scDNA.pdf", "scDNA.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
